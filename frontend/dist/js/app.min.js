const getApiBaseUrl =()=>{if(typeof window !== 'undefined' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1'){return 'https:}if(typeof window !== 'undefined' && window.location.port === '5500'){return 'http:}return 'http:};const API_BASE_URL = getApiBaseUrl();const checkBackendConnectivity = async()=>{try{const endpointsToTry = [ '/api/users/login','/api/products','/',];for(const endpoint of endpointsToTry){try{console.log(`Intentando conectar a:${API_BASE_URL}${endpoint}`);const controller = new AbortController();const timeoutId = setTimeout(()=> controller.abort(),5000);const response = await fetch(`${API_BASE_URL}${endpoint}`,{method:'GET',signal:controller.signal,headers:{'Accept':'application/json'}}).catch(error =>{clearTimeout(timeoutId);throw error;});clearTimeout(timeoutId);console.log(`Respuesta del servidor:${response.status}`);if(response.status < 500){console.log(`Backend conectado correctamente a ${API_BASE_URL}${endpoint}con estado ${response.status}`);return true;}}catch(endpointError){console.warn(`No se pudo conectar a ${API_BASE_URL}${endpoint}:`,endpointError.message);if(endpointError.name === 'AbortError'){console.warn(`Timeout al conectar a ${API_BASE_URL}${endpoint}`);}}}console.warn('No se pudo establecer conexión con ningún endpoint del backend');return false;}catch(error){console.warn('Error general en la verificación de conectividad:',error);return false;}};function showNotification(message,type = 'info'){if(type === 'error'){console.error('Error notification:',message);}else if(type === 'warning'){console.warn('Warning notification:',message);}else{console.log('Info notification:',message);}let notificationContainer = document.getElementById('notificationContainer');if(!notificationContainer){notificationContainer = document.createElement('div');notificationContainer.id = 'notificationContainer';notificationContainer.style.cssText = ` position:fixed;top:20px;right:20px;z-index:10000;width:300px;`;document.body.appendChild(notificationContainer);}const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.style.cssText = ` background:${type === 'error' ? '#f44336':type === 'success' ? '#4caf50':type === 'warning' ? '#ff9800':'#2196f3'};color:white;padding:16px;margin-bottom:10px;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,0.2);position:relative;animation:notificationSlideIn 0.3s ease-out;font-family:'Poppins',sans-serif;display:flex;justify-content:space-between;align-items:center;`;const messageDiv = document.createElement('div');messageDiv.textContent = message;notification.appendChild(messageDiv);const closeBtn = document.createElement('button');closeBtn.innerHTML = '&times;';closeBtn.style.cssText = ` position:absolute;top:5px;right:10px;background:none;border:none;color:white;font-size:20px;cursor:pointer;padding:0;width:20px;height:20px;line-height:18px;text-align:center;`;closeBtn.onclick =()=>{notification.remove();};notification.appendChild(closeBtn);notificationContainer.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove();}},5000);return notification;}const formatPrice =(price)=>{return new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',minimumFractionDigits:0,maximumFractionDigits:0}).format(price);};function updateCartCount(){const cart = JSON.parse(localStorage.getItem('cart')|| '[]');const count = cart.reduce((total,item)=> total + item.quantity,0);const cartCountElements = document.querySelectorAll('.cart-count');cartCountElements.forEach(element =>{element.textContent = count;});}const validateEmail =(email)=>{const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;return re.test(email);};const validatePhone =(phone)=>{const re = /^(\+56)?[\s\-]?[9\d][\s\-]?\d{4}[\s\-]?\d{4}$/;return re.test(phone.replace(/\s+/g,' ').trim());};const isAuthenticated =()=>{const token = localStorage.getItem('token');if(!token)return false;try{const payload = JSON.parse(atob(token.split('.')[1]));const currentTime = Date.now()/ 1000;if(payload.exp < currentTime){localStorage.removeItem('token');localStorage.removeItem('user');return false;}return true;}catch(e){if(token.length < 10){localStorage.removeItem('token');localStorage.removeItem('user');return false;}return true;}};const isAdmin =()=>{if(!isAuthenticated())return false;const user = JSON.parse(localStorage.getItem('user')|| '{}');return user.role === 'admin';};const getUser =()=>{if(!isAuthenticated())return null;const userStr = localStorage.getItem('user');if(!userStr)return null;try{return JSON.parse(userStr);}catch(e){return null;}};const requireAuth =()=>{if(!isAuthenticated()){window.location.href = 'login.html';return false;}return true;};const requireAdmin =()=>{if(!isAuthenticated()){window.location.href = 'login.html';return false;}if(!isAdmin()){showNotification('Acceso denegado. Se requiere rol de administrador.','error');window.location.href = 'index.html';return false;}return true;};const getAuthToken =()=>{return localStorage.getItem('token');};function handleNetworkError(error){console.error('Error de red:',error);if(error.name === 'TypeError' && error.message.includes('fetch')){showNotification('Error de conexión. Por favor,verifica tu conexión a internet.','error');}else{showNotification('Ocurrió un error. Por favor,inténtalo de nuevo.','error');}}async function apiRequest(endpoint,options ={}){try{const token = getAuthToken();const defaultOptions ={headers:{'Content-Type':'application/json',}};if(token){defaultOptions.headers['Authorization'] = `Bearer ${token}`;}const mergedOptions ={...defaultOptions,...options,headers:{...defaultOptions.headers,...options.headers}};const response = await fetch(`${API_BASE_URL}${endpoint}`,mergedOptions);if(!response.ok){if(response.status === 401){localStorage.removeItem('token');localStorage.removeItem('user');window.location.href = 'login.html';throw new Error('No autorizado');}const errorData = await response.json().catch(()=>({}));throw new Error(errorData.message || `Error HTTP:${response.status}`);}return await response.json();}catch(error){handleNetworkError(error);throw error;}}const logout =()=>{localStorage.removeItem('token');localStorage.removeItem('user');};export{showNotification,formatPrice,updateCartCount,validateEmail,validatePhone,isAuthenticated,isAdmin,getUser,requireAuth,requireAdmin,getAuthToken,handleNetworkError,apiRequest,logout,API_BASE_URL,checkBackendConnectivity};import{updateCartCount,getUser,isAuthenticated,logout,isAdmin,API_BASE_URL}from './utils.js';function initUserMenu(){console.log('Iniciando menú de usuario');if(!isAuthenticated()){localStorage.removeItem('user');}const user = getUser();const userMenu = document.getElementById('userMenu');const loginLink = document.getElementById('loginLink');const userNameElement = document.getElementById('userNameDisplay');const logoutLink = document.getElementById('logoutLink');const userDropdown = document.querySelector('.user-dropdown');const userMenuButton = document.querySelector('.user-info');const caretIcon = userMenuButton ? userMenuButton.querySelector('.fas.fa-caret-down'):null;console.log('Elementos encontrados:',{userMenu,loginLink,userNameElement,logoutLink,userDropdown,userMenuButton});if(userNameElement){userNameElement.textContent = '';}if(isAuthenticated()&& user){console.log('Usuario autenticado:',user);if(userMenu){userMenu.style.display = 'block';console.log('Mostrando menú de usuario');}if(loginLink){loginLink.style.display = 'none';console.log('Ocultando botón de inicio de sesión');}if(userMenuButton){userMenuButton.setAttribute('aria-expanded','false');userMenuButton.setAttribute('aria-haspopup','true');userMenuButton.setAttribute('role','button');userMenuButton.setAttribute('tabindex','0');}if(userNameElement){userNameElement.textContent = user.name || 'Usuario';}if(caretIcon){caretIcon.style.display = 'inline';caretIcon.setAttribute('aria-hidden','true');}if(isAdmin()){addAdminLinkToMenu();}if(logoutLink){const newLogoutLink = logoutLink.cloneNode(true);logoutLink.parentNode.replaceChild(newLogoutLink,logoutLink);const freshLogoutLink = document.getElementById('logoutLink');freshLogoutLink.addEventListener('click',function(e){e.preventDefault();handleLogout();});freshLogoutLink.setAttribute('role','menuitem');freshLogoutLink.setAttribute('tabindex','-1');}if(userMenuButton && userDropdown){const newUserMenuButton = userMenuButton.cloneNode(true);userMenuButton.parentNode.replaceChild(newUserMenuButton,userMenuButton);const freshUserMenuButton = document.querySelector('.user-info');userDropdown.style.display = 'none';freshUserMenuButton.addEventListener('click',function(e){e.stopPropagation();toggleUserDropdown();});freshUserMenuButton.addEventListener('keydown',function(e){if(e.key === 'Enter' || e.key === ' '){e.preventDefault();e.stopPropagation();toggleUserDropdown();}});freshUserMenuButton.setAttribute('role','button');freshUserMenuButton.setAttribute('tabindex','0');freshUserMenuButton.setAttribute('aria-expanded','false');freshUserMenuButton.setAttribute('aria-haspopup','true');document.removeEventListener('click',closeUserDropdown);document.addEventListener('click',closeUserDropdown);document.removeEventListener('keydown',handleEscapeKey);document.addEventListener('keydown',handleEscapeKey);}}else{console.log('Usuario no autenticado');if(loginLink){loginLink.style.display = 'block';console.log('Mostrando botón de inicio de sesión');}if(userMenu){userMenu.style.display = 'none';console.log('Ocultando menú de usuario');}}}function closeUserDropdown(e){const userDropdown = document.querySelector('.user-dropdown');const userMenuButton = document.querySelector('.user-info');if(userDropdown && userMenuButton && !userDropdown.contains(e.target)&& !userMenuButton.contains(e.target)){userDropdown.style.display = 'none';userMenuButton.setAttribute('aria-expanded','false');}}function handleEscapeKey(e){if(e.key === 'Escape'){const userDropdown = document.querySelector('.user-dropdown');const userMenuButton = document.querySelector('.user-info');if(userDropdown && userMenuButton){userDropdown.style.display = 'none';userMenuButton.setAttribute('aria-expanded','false');}}}function toggleUserDropdown(){const userDropdown = document.querySelector('.user-dropdown');const userMenuButton = document.querySelector('.user-info');if(userDropdown && userMenuButton){const isExpanded = userMenuButton.getAttribute('aria-expanded')=== 'true';if(isExpanded){userDropdown.style.display = 'none';userMenuButton.setAttribute('aria-expanded','false');}else{userDropdown.style.display = 'block';userMenuButton.setAttribute('aria-expanded','true');}}}function addAdminLinkToMenu(){const userDropdown = document.querySelector('.user-dropdown');const adminLink = document.querySelector('[href="pages/admin.html"]');if(adminLink)return;if(userDropdown){const adminListItem = document.createElement('li');adminListItem.innerHTML = '<a href="pages/admin.html" role="menuitem"><i class="fas fa-cog" aria-hidden="true"></i> Panel de Administración</a>';const logoutItem = userDropdown.querySelector('[id="logoutLink"]').parentNode;userDropdown.insertBefore(adminListItem,logoutItem);}}function handleLogout(){logout();window.location.href = 'index.html';}export{initUserMenu};import Cart,{saveCartToLocalStorage,loadCartFromLocalStorage}from '../../components/Cart.js';import{showNotification}from './utils.js';const CartUtils ={init(){this.cartItems = loadCartFromLocalStorage();this.savedForLater = this.loadSavedItems();this.updateCartCount();},getCartItems(){return this.cartItems || [];},addToCart(product){const existingItem = this.cartItems.find(item => item.id == product.id);if(existingItem){existingItem.quantity += 1;showNotification(`${product.name}cantidad actualizada en el carrito`,'success');}else{this.cartItems.push({id:product.id,name:product.name,price:parseFloat(product.price),image:product.image,quantity:1});showNotification(`${product.name}agregado al carrito`,'success');}saveCartToLocalStorage(this.cartItems);this.updateCartCount();this.renderCart();},removeFromCart(productId){const item = this.cartItems.find(item => item.id == productId);if(item){this.cartItems = this.cartItems.filter(item => item.id != productId);saveCartToLocalStorage(this.cartItems);this.updateCartCount();this.renderCart();showNotification(`${item.name}eliminado del carrito`,'info');}},updateQuantity(productId,quantity){const item = this.cartItems.find(item => item.id == productId);if(item){if(quantity <= 0){this.removeFromCart(productId);}else{item.quantity = quantity;saveCartToLocalStorage(this.cartItems);this.renderCart();showNotification(`Cantidad de ${item.name}actualizada`,'success');}}},clearCart(){this.cartItems = [];saveCartToLocalStorage(this.cartItems);this.updateCartCount();this.renderCart();showNotification('Carrito vaciado','info');},updateCartCount(){const cartCountElement = document.querySelector('.cart-count');if(cartCountElement){const totalItems = this.cartItems.reduce((total,item)=> total + item.quantity,0);cartCountElement.textContent = totalItems;}},toggleCartModal(){const cartModal = document.getElementById('cartModal');if(cartModal){cartModal.classList.toggle('show');document.body.classList.toggle('cart-open');if(cartModal.classList.contains('show')){this.renderCart();}}},renderCart(){const cartContainer = document.getElementById('cartContainer');if(cartContainer){cartContainer.innerHTML = Cart(this.cartItems,this.savedForLater);this.attachCartEventListeners();}},attachCartEventListeners(){this.removeCartEventListeners();const closeCartButton = document.querySelector('.cart-close');if(closeCartButton){closeCartButton._toggleCart =()=>{this.toggleCartModal();};closeCartButton._keydownHandler =(e)=>{if(e.key === 'Enter'){this.toggleCartModal();}};closeCartButton.addEventListener('click',closeCartButton._toggleCart);closeCartButton.addEventListener('keydown',closeCartButton._keydownHandler);}document.querySelectorAll('.increase-btn').forEach(button =>{button.addEventListener('click',(e)=>{const productId = e.target.closest('.cart-item').dataset.id;const item = this.cartItems.find(item => item.id == productId);if(item){this.updateQuantity(productId,item.quantity + 1);}});});document.querySelectorAll('.decrease-btn').forEach(button =>{button.addEventListener('click',(e)=>{const productId = e.target.closest('.cart-item').dataset.id;const item = this.cartItems.find(item => item.id == productId);if(item){this.updateQuantity(productId,item.quantity - 1);}});});document.querySelectorAll('.remove-btn').forEach(button =>{button.addEventListener('click',(e)=>{const productId = e.target.closest('.cart-item').dataset.id;this.removeFromCart(productId);});});document.querySelectorAll('.save-for-later-btn').forEach(button =>{button.addEventListener('click',(e)=>{const productId = e.target.closest('.cart-item').dataset.id;this.saveForLater(productId);});});document.querySelectorAll('.move-to-cart-btn').forEach(button =>{button.addEventListener('click',(e)=>{const productId = e.target.closest('.saved-item').dataset.id;this.moveToCart(productId);});});document.querySelectorAll('.remove-saved-btn').forEach(button =>{button.addEventListener('click',(e)=>{const productId = e.target.closest('.saved-item').dataset.id;this.removeSavedItem(productId);});});const checkoutButton = document.querySelector('.checkout-button');if(checkoutButton){checkoutButton.addEventListener('click',()=>{if(this.cartItems.length > 0){showNotification('Procediendo al pedido...','info');}});}const cartModal = document.getElementById('cartModal');if(cartModal){cartModal.addEventListener('click',(e)=>{if(e.target === cartModal){this.toggleCartModal();}});}},saveForLater(productId){const itemIndex = this.cartItems.findIndex(item => item.id == productId);if(itemIndex !== -1){const item = this.cartItems.splice(itemIndex,1)[0];this.savedForLater.push(item);saveCartToLocalStorage(this.cartItems);this.saveSavedItems();this.updateCartCount();this.renderCart();showNotification(`${item.name}guardado para más tarde`,'success');}},moveToCart(productId){const itemIndex = this.savedForLater.findIndex(item => item.id == productId);if(itemIndex !== -1){const item = this.savedForLater.splice(itemIndex,1)[0];this.cartItems.push(item);saveCartToLocalStorage(this.cartItems);this.saveSavedItems();this.updateCartCount();this.renderCart();showNotification(`${item.name}movido al carrito`,'success');}},removeSavedItem(productId){this.savedForLater = this.savedForLater.filter(item => item.id != productId);this.saveSavedItems();this.renderCart();showNotification('Producto eliminado de guardados','info');},loadSavedItems(){try{const savedItems = localStorage.getItem('savedForLater');return savedItems ? JSON.parse(savedItems):[];}catch(error){console.error('Error al cargar items guardados:',error);return [];}},saveSavedItems(){try{localStorage.setItem('savedForLater',JSON.stringify(this.savedForLater));}catch(error){console.error('Error al guardar items guardados:',error);}}};document.addEventListener('DOMContentLoaded',()=>{CartUtils.init();return CartUtils;});export default CartUtils;async function getProducts(){try{const response = await fetch('/api/products');if(!response.ok){throw new Error('Error al obtener productos');}return await response.json();}catch(error){console.error('Error al obtener productos:',error);throw error;}}async function getProductReviews(productId){try{const response = await fetch(`/api/products/${productId}/reviews`);if(!response.ok){throw new Error('Error al obtener reseñas');}return await response.json();}catch(error){console.error('Error al obtener reseñas:',error);return [];}}async function addProductReview(productId,reviewData){try{const response = await fetch(`/api/products/${productId}/reviews`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reviewData)});if(!response.ok){throw new Error('Error al agregar reseña');}return await response.json();}catch(error){console.error('Error al agregar reseña:',error);throw error;}}function calculateAverageRating(reviews){if(!reviews || reviews.length === 0)return 0;const total = reviews.reduce((sum,review)=> sum + review.rating,0);return Math.round((total / reviews.length)* 10)/ 10;}function displayProductReviews(productId){getProductReviews(productId).then(reviews =>{const reviewsContainer = document.getElementById('productReviews');if(!reviewsContainer)return;if(reviews.length === 0){reviewsContainer.innerHTML = '<p>No hay reseñas para este producto aún.</p>';return;}const averageRating = calculateAverageRating(reviews);reviewsContainer.innerHTML = ` <div class="reviews-header"> <h3>Reseñas del producto</h3> <div class="average-rating"> <span class="rating-value">${averageRating}</span> <div class="stars">${renderStars(averageRating)}</div> <span class="review-count">(${reviews.length}reseñas)</span> </div> </div> <div class="reviews-list"> ${reviews.map(review => ` <div class="review-item"> <div class="review-header"> <strong>${review.userName}</strong> <div class="stars">${renderStars(review.rating)}</div> <span class="review-date">${formatDate(review.date)}</span> </div> <p class="review-comment">${review.comment}</p> </div> `).join('')}</div> `;}).catch(error =>{console.error('Error al mostrar reseñas:',error);});}function renderStars(rating){const fullStars = Math.floor(rating);const hasHalfStar = rating % 1 >= 0.5;const emptyStars = 5 - fullStars -(hasHalfStar ? 1:0);return ` ${'<i class="fas fa-star"></i>'.repeat(fullStars)}${hasHalfStar ? '<i class="fas fa-star-half-alt"></i>':''}${'<i class="far fa-star"></i>'.repeat(emptyStars)}`;}function formatDate(dateString){const options ={year:'numeric',month:'long',day:'numeric'};return new Date(dateString).toLocaleDateString('es-ES',options);}export{getProducts,getProductReviews,addProductReview,displayProductReviews,calculateAverageRating};import{API_BASE_URL,formatPrice,showNotification}from './utils.js';async function loadHomeProducts(){const productGrid = document.getElementById('products');if(!productGrid){console.error('No se encontró el contenedor de productos');return;}try{console.log('Cargando productos...');const response = await fetch(`${API_BASE_URL}/api/products?limit=8`);if(!response.ok){throw new Error(`Error al cargar productos:${response.status}${response.statusText}`);}const products = await response.json();console.log('Productos cargados:',products);if(products.length === 0){productGrid.innerHTML = '<div class="no-products-message">No hay productos disponibles en este momento.</div>';return;}const productsHTML = products.map(product => ` <div class="product-card"> <div class="product-image"> <img src="${product.image || './assets/images/placeholder.svg'}" alt="${product.name || 'Producto sin nombre'}" loading="lazy" itemprop="image" width="300" height="200" decoding="async" fetchpriority="auto" onerror="this.src='./assets/images/placeholder.svg'"> <div class="image-error-overlay">Imagen no disponible</div> </div> <div class="product-info"> <h3>${product.name}</h3> <p class="product-description">${product.description || 'Descripción no disponible'}</p> <p class="product-price">${formatPrice(product.price)}</p> <button class="btn btn-primary add-to-cart" data-product-id="${product.id}"> <i class="fas fa-shopping-cart"></i> Agregar al carrito </button> </div> </div> `).join('');productGrid.innerHTML = productsHTML;const addToCartButtons = productGrid.querySelectorAll('.add-to-cart');addToCartButtons.forEach(button =>{button.addEventListener('click',async function(){const productId = this.getAttribute('data-product-id');const product = products.find(p => p.id == productId);if(product){try{const response = await fetch(`${API_BASE_URL}/api/cart/add`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId:product.id,quantity:1})});if(response.ok){showAddToCartNotification(product.name);updateCartCount();}else{fallbackAddToCart(product);showNotification(`Producto "${product.name}" agregado al carrito localmente`,'warning');}}catch(error){fallbackAddToCart(product);showNotification(`Producto "${product.name}" agregado al carrito localmente`,'warning');}}});});}catch(error){console.error('Error al cargar productos:',error);productGrid.innerHTML = ` <div class="error-message"> Error al cargar productos. <button class="retry-button" onclick="location.reload()">Reintentar</button> </div> `;}}function fallbackAddToCart(product){let cart = JSON.parse(localStorage.getItem('arreglosVictoriaCart'))|| [];const existingItem = cart.find(item => item.id == product.id);if(existingItem){existingItem.quantity += 1;}else{cart.push({id:product.id,name:product.name,price:product.price,image:product.image,quantity:1});}localStorage.setItem('arreglosVictoriaCart',JSON.stringify(cart));}function updateCartCount(){fetch(`${API_BASE_URL}/api/cart/count`).then(response =>{if(response.ok){return response.json();}return Promise.reject('No se pudo obtener el conteo del carrito');}).then(data =>{document.querySelectorAll('.cart-count,#cartCount').forEach(element =>{element.textContent = data.count;});}).catch(async()=>{let cart = JSON.parse(localStorage.getItem('arreglosVictoriaCart'))|| [];const cartCount = cart.reduce((total,item)=> total + item.quantity,0);document.querySelectorAll('.cart-count,#cartCount').forEach(element =>{element.textContent = cartCount;});});}function showAddToCartNotification(productName){const notification = document.createElement('div');notification.className = 'add-to-cart-notification';notification.innerHTML = ` <i class="fas fa-check-circle"></i> <span>${productName}agregado al carrito</span> `;notification.style.cssText = ` position:fixed;top:20px;right:20px;background:#4caf50;color:white;padding:16px 24px;border-radius:4px;box-shadow:0 2px 5px rgba(0,0,0,0.2);z-index:10000;display:flex;align-items:center;gap:10px;font-family:'Poppins',sans-serif;animation:slideIn 0.3s,fadeOut 0.5s 2.5s;transition:opacity 0.3s ease-out;`;const style = document.createElement('style');style.textContent = ` @keyframes slideIn{from{transform:translateX(100%);}to{transform:translateX(0);}}@keyframes fadeOut{from{opacity:1;}to{opacity:0;}}`;document.head.appendChild(style);document.body.appendChild(notification);setTimeout(()=>{notification.classList.add('fadeOut');notification.addEventListener('animationend',()=>{notification.remove();style.remove();});},3000);}document.addEventListener('DOMContentLoaded',()=>{loadHomeProducts();updateCartCount();});function handleImageError(imgElement){imgElement.src = './assets/images/placeholder.svg';imgElement.setAttribute('aria-label','Imagen no disponible');}window.handleImageError = function(imgElement){imgElement.src = './assets/images/placeholder.svg';};window.updateCartCount = updateCartCount;import{API_BASE_URL,showNotification}from './utils.js';import{initUserMenu}from './auth.js';function debounce(func,wait){let timeout;return function executedFunction(...args){const later =()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout = setTimeout(later,wait);};}async function loadAllProducts(){try{console.log('Cargando productos desde:',`${API_BASE_URL}/api/products`);const response = await fetch(`${API_BASE_URL}/api/products`);if(!response.ok){throw new Error('Error al cargar los productos');}const products = await response.json();displayProducts(products.products || products);updateProductCount((products.products || products).length);return products;}catch(error){console.error('Error al cargar productos:',error);showNotification('Error al cargar los productos. Por favor,intente nuevamente.','error');return [];}}function displayProducts(products){const container = document.getElementById('productGrid');if(!container)return;const productList = products.products || products;if(productList.length === 0){container.innerHTML = '<p class="no-products">No se encontraron productos.</p>';return;}container.innerHTML = productList.map(product => ` <div class="product-card" data-category="${product.category}"> <div class="product-image"> <img src="${product.image_url || product.image}" alt="${product.name}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOHB4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjM1ZW0iIGZpbGw9IiM5OTkiPkltYWdlbiBubyBkaXNwb25pYmxlPC90ZXh0Pjwvc3ZnPg==';this.onerror=null;"> <button class="add-to-cart" data-product-id="${product.id}"> <i class="fas fa-shopping-cart"></i> Agregar al carrito </button> </div> <div class="product-info"> <h3>${product.name}</h3> <p class="product-description">${product.description}</p> <div class="product-price">$${product.price.toLocaleString()}</div> <div class="product-category">${getCategoryName(product.category)}</div> </div> </div> `).join('');document.querySelectorAll('.add-to-cart').forEach(button =>{button.addEventListener('click',function(){const productId = this.getAttribute('data-product-id');addToCart(productId);});});}function getCategoryName(categoryKey){const categories ={'arreglos':'Arreglos Florales','ramos':'Ramos','plantas':'Plantas','accesorios':'Accesorios'};return categories[categoryKey] || categoryKey;}function addToCart(productId){showNotification('Producto agregado al carrito','success');}function filterProducts(category){const products = document.querySelectorAll('.product-card');let visibleCount = 0;products.forEach(product =>{if(category === 'all' || product.getAttribute('data-category')=== category){product.style.display = 'block';visibleCount++;}else{product.style.display = 'none';}});updateProductCount(visibleCount);}function updateProductCount(count){const countElement = document.getElementById('productCount');if(countElement){countElement.textContent = `${count}productos disponibles`;}}function searchProducts(query,allProducts){if(!query){displayProducts(allProducts);updateProductCount(allProducts.length);return;}const filteredProducts = allProducts.filter(product => product.name.toLowerCase().includes(query.toLowerCase())|| product.description.toLowerCase().includes(query.toLowerCase())|| product.category.toLowerCase().includes(query.toLowerCase()));displayProducts(filteredProducts);updateProductCount(filteredProducts.length);}function sortProducts(products,sortBy){const sortedProducts = [...products];switch(sortBy){case 'name-asc':sortedProducts.sort((a,b)=> a.name.localeCompare(b.name));break;case 'name-desc':sortedProducts.sort((a,b)=> b.name.localeCompare(a.name));break;case 'price-asc':sortedProducts.sort((a,b)=> a.price - b.price);break;case 'price-desc':sortedProducts.sort((a,b)=> b.price - a.price);break;default:return sortedProducts;}return sortedProducts;}document.addEventListener('DOMContentLoaded',async function(){console.log('DOM cargado en products.js');const categoryLinks = document.querySelectorAll('.category-filter a');categoryLinks.forEach(link =>{link.addEventListener('click',function(e){e.preventDefault();const category = this.getAttribute('data-category');categoryLinks.forEach(l => l.classList.remove('active'));this.classList.add('active');filterProducts(category);});});const searchInput = document.getElementById('searchInput');if(searchInput){const debouncedSearch = debounce((query)=>{searchProducts(query,allProducts);},300);searchInput.addEventListener('input',function(){debouncedSearch(this.value);});}const sortSelect = document.getElementById('sortSelect');if(sortSelect){sortSelect.addEventListener('change',function(){const sortedProducts = sortProducts(allProducts,this.value);displayProducts(sortedProducts);});}});document.addEventListener('DOMContentLoaded',function(){try{initUserMenu();console.log('Menú de usuario inicializado en products.js');}catch(error){console.error('Error al inicializar el menú de usuario en products.js:',error);}loadAllProducts();});function CartModal(cartItems = [],savedForLaterItems = []){return ` <div id="cartModal" class="cart-modal"> <div class="cart-modal-content"> <span class="cart-close">&times;</span> <h2>Tu Carrito</h2> <div class="cart-section"> <h3>Productos en tu carrito</h3> <div class="cart-items"> ${renderCartItems(cartItems)}</div> </div> <div class="cart-section"> <h3>Guardados para más tarde</h3> <div class="saved-for-later"> ${renderSavedForLater(savedForLaterItems)}</div> </div> <div class="cart-summary"> <p>Total:<span class="total-amount">${formatPrice(CalculateCartTotal(cartItems))}</span></p> <button class="checkout-button">Proceder al pedido</button> </div> </div> </div> `;}function renderCartItems(items){if(items.length === 0){return '<p class="empty-cart-message">Tu carrito está vacío</p>';}return items.map(item => ` <div class="cart-item" data-id="${item.id}"> <img src="${item.image}" alt="${item.name}" class="cart-item-image"> <div class="cart-item-details"> <h4 class="cart-item-name">${item.name}</h4> <p class="cart-item-price">${formatPrice(item.price)}</p> <div class="cart-item-quantity"> <button class="quantity-btn decrease-btn" data-id="${item.id}">-</button> <span class="quantity">${item.quantity}</span> <button class="quantity-btn increase-btn" data-id="${item.id}">+</button> </div> <p class="cart-item-total">${formatPrice(item.price * item.quantity)}</p> </div> <div class="cart-item-actions"> <button class="remove-btn" data-id="${item.id}">×</button> <button class="save-for-later" data-id="${item.id}">Guardar para más tarde</button> </div> </div> `).join('');}function renderSavedForLater(items){if(items.length === 0){return '<p>No tienes productos guardados</p>';}return items.map(item => ` <div class="saved-item" data-id="${item.id}"> <img src="${item.image}" alt="${item.name}" class="saved-item-image"> <div class="saved-item-details"> <h4>${item.name}</h4> <p>${formatPrice(item.price)}</p> </div> <button class="move-to-cart" data-id="${item.id}">Mover al carrito</button> </div> `).join('');}function CalculateCartTotal(items){return items.reduce((total,item)=> total +(item.price * item.quantity),0);}export default CartModal;import{showNotification,getUser,isAuthenticated,formatPrice}from './utils.js';import CartUtils from './cartUtils.js';import Cart from '../../components/Cart.js';document.addEventListener('DOMContentLoaded',function(){const cartIcon = document.querySelector('.cart-icon');const cartClose = document.querySelector('.cart-close');const cartItemsContainer = document.querySelector('.cart-items');const totalAmount = document.querySelector('.total-amount');const checkoutButton = document.querySelector('.checkout-button');if(cartIcon){cartIcon.addEventListener('click',function(){showCart();});}if(cartClose){cartClose.addEventListener('click',function(){hideCart();});}document.addEventListener('click',function(event){const cartModal = document.getElementById('cartModal');if(cartModal && event.target === cartModal){hideCart();}});if(checkoutButton){checkoutButton.addEventListener('click',function(){const cart = CartUtils.getCart();if(cart.length === 0){showNotification('Tu carrito está vacío','error');return;}if(!isAuthenticated()){showNotification('Debes iniciar sesión para continuar con el pedido','error');console.log('Usuario no autenticado,redirigiendo a login');setTimeout(()=>{window.location.href = 'login.html';},1500);return;}window.location.href = 'checkout.html';});}function showCart(){const cart = CartUtils.getCart();const savedForLater = CartUtils.getSavedForLater();let cartModal = document.getElementById('cartModal');if(!cartModal){const cartContainer = document.createElement('div');cartContainer.innerHTML = CartModal(cart,savedForLater);document.body.appendChild(cartContainer);attachEventListeners();}else{cartModal.querySelector('.cart-items').innerHTML = renderCartItems(cart);cartModal.querySelector('.saved-for-later').innerHTML = renderSavedForLater(savedForLater);cartModal.querySelector('.total-amount').textContent = formatPrice(CalculateCartTotal(cart));}document.getElementById('cartModal').style.display = 'block';}function hideCart(){const cartModal = document.getElementById('cartModal');if(cartModal){cartModal.style.display = 'none';}}function attachEventListeners(){document.querySelectorAll('.increase-btn').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.dataset.id);CartUtils.updateQuantity(id,1);showCart();});});document.querySelectorAll('.decrease-btn').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.dataset.id);CartUtils.updateQuantity(id,-1);showCart();});});document.querySelectorAll('.remove-btn').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.dataset.id);CartUtils.removeFromCart(id);showCart();showNotification('Producto eliminado del carrito','success');});});document.querySelectorAll('.save-for-later').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.dataset.id);CartUtils.saveForLater(id);showCart();showNotification('Producto guardado para más tarde','success');});});document.querySelectorAll('.move-to-cart').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.dataset.id);CartUtils.moveToCart(id);showCart();showNotification('Producto movido al carrito','success');});});}function updateCartCounter(){const cart = CartUtils.getCart();const totalItems = cart.reduce((total,item)=> total + item.quantity,0);const cartCounter = document.querySelector('.cart-counter');if(cartCounter){cartCounter.textContent = totalItems;cartCounter.style.display = totalItems > 0 ? 'inline':'none';}}updateCartCounter();document.addEventListener('cartUpdated',updateCartCounter);});import{showNotification,updateCartCount,formatPrice,getUser,isAuthenticated}from './utils.js';import{initUserMenu}from './auth.js';document.addEventListener('DOMContentLoaded',function(){initUserMenu();const orderItems = document.querySelector('.order-items');const totalAmount = document.querySelector('.total-amount');const paymentForm = document.getElementById('paymentForm');if(!isAuthenticated()){showNotification('Debes iniciar sesión para continuar con el pedido','error');setTimeout(()=>{window.location.href = 'login.html';},1500);return;}loadOrderSummary();paymentForm.addEventListener('submit',function(e){e.preventDefault();const cardNumber = document.getElementById('cardNumber').value;const expiryDate = document.getElementById('expiryDate').value;const cvv = document.getElementById('cvv').value;const cardName = document.getElementById('cardName').value;const billingAddress = document.getElementById('billingAddress').value;if(!cardNumber || !expiryDate || !cvv || !cardName || !billingAddress){showNotification('Por favor completa todos los campos','error');return;}processPayment({cardNumber,expiryDate,cvv,cardName,billingAddress});});function loadOrderSummary(){const cart = JSON.parse(localStorage.getItem('cart'))|| [];if(cart.length === 0){orderItems.innerHTML = '<p class="empty-order-message">No hay productos en tu pedido</p>';totalAmount.textContent = '$0.00';return;}const total = cart.reduce((sum,item)=> sum +(item.price * item.quantity),0);orderItems.innerHTML = cart.map(item => ` <div class="order-item"> <div class="order-item-image"> <img src="${item.image}" alt="${item.name}"> </div> <div class="order-item-details"> <h4>${item.name}</h4> <p>${item.quantity}x ${formatPrice(item.price)}</p> </div> <div class="order-item-total"> ${formatPrice(item.price * item.quantity)}</div> </div> `).join('');totalAmount.textContent = formatPrice(total);}async function processPayment(paymentData){showNotification('Procesando pago...','info');try{const cart = JSON.parse(localStorage.getItem('cart'))|| [];const user = getUser();if(cart.length === 0){throw new Error('El carrito está vacío');}const total = cart.reduce((sum,item)=> sum +(item.price * item.quantity),0);const shippingFirstName = document.getElementById('shippingFirstName')?.value || '';const shippingLastName = document.getElementById('shippingLastName')?.value || '';const shippingAddress = document.getElementById('shippingAddress')?.value || paymentData.billingAddress;const shippingPhone = document.getElementById('shippingPhone')?.value || '';const shippingEmail = document.getElementById('shippingEmail')?.value || user.email;const orderData ={userId:user.id,customerName:user.name,customerEmail:shippingEmail,items:cart.map(item =>({productId:item.id,productName:item.name,quantity:item.quantity,price:item.price})),total:total,shippingAddress:shippingAddress,paymentMethod:'Tarjeta de crédito'};const response = await fetch('http:method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(orderData)});if(!response.ok){const errorData = await response.json();throw new Error(errorData.error || 'Error al crear el pedido');}const order = await response.json();setTimeout(()=>{showNotification('¡Pago procesado exitosamente!','success');localStorage.removeItem('cart');updateCartCount();console.log('Pago procesado para el usuario:',user);console.log('Datos de pago:',paymentData);console.log('Pedido creado:',order);const orderNumberElement = document.getElementById('orderNumber');if(orderNumberElement){orderNumberElement.innerHTML = `Número de pedido:<strong>#${order.id}</strong>`;}const orderItemsElement = document.getElementById('orderItems');if(orderItemsElement){orderItemsElement.innerHTML = order.items.map(item => ` <div class="order-item"> <div class="order-item-details"> <h4>${item.productName}</h4> <p>${item.quantity}x ${formatPrice(item.price)}</p> </div> <div class="order-item-total"> ${formatPrice(item.quantity * item.price)}</div> </div> `).join('');}const paidAmountElement = document.getElementById('paidAmount');if(paidAmountElement){paidAmountElement.textContent = formatPrice(order.total);}document.querySelectorAll('.checkout-step').forEach(step =>{step.classList.remove('active');});document.getElementById('confirmation-step').classList.add('active');document.querySelectorAll('.step').forEach(step =>{step.classList.remove('active','completed');});document.querySelector('.step[data-step="confirmation"]').classList.add('active','completed');document.querySelector('.step[data-step="payment"]').classList.add('completed');},2000);}catch(error){console.error('Error al procesar el pago:',error);showNotification(`Error al procesar el pago:${error.message}`,'error');}}updateCartCount();});import{initUserMenu}from './auth.js';import{formatPrice,getUser}from './utils.js';document.addEventListener('DOMContentLoaded',function(){initUserMenu();const token = localStorage.getItem('token');const user = getUser();if(!token || !user){window.location.href = 'login.html';return;}displayUserInfo(user);setupEventListeners();loadUserStats();loadUserOrders(user.id);});function displayUserInfo(user){const userNameElement = document.getElementById('userName');const userEmailElement = document.getElementById('userEmail');const profileFirstName = document.getElementById('profileFirstName');const profileLastName = document.getElementById('profileLastName');const profileEmail = document.getElementById('profileEmail');const profilePhone = document.getElementById('profilePhone');const profileAddress = document.getElementById('profileAddress');if(userNameElement)userNameElement.textContent = user.name || 'Usuario';if(userEmailElement)userEmailElement.textContent = user.email || '';if(profileFirstName)profileFirstName.value = user.name ? user.name.split(' ')[0]:'';if(profileLastName){const nameParts = user.name ? user.name.split(' '):[];profileLastName.value = nameParts.length > 1 ? nameParts.slice(1).join(' '):'';}if(profileEmail)profileEmail.value = user.email || '';if(profilePhone)profilePhone.value = user.phone || '';if(profileAddress)profileAddress.value = user.address || '';}function setupEventListeners(){const logoutButton = document.getElementById('logoutButton');if(logoutButton){logoutButton.addEventListener('click',function(e){e.preventDefault();handleLogout();});}const profileForm = document.getElementById('profileForm');if(profileForm){profileForm.addEventListener('submit',function(e){e.preventDefault();updateProfile();});}const changePasswordForm = document.getElementById('changePasswordForm');if(changePasswordForm){changePasswordForm.addEventListener('submit',function(e){e.preventDefault();changePassword();});}const settingsForm = document.getElementById('settingsForm');if(settingsForm){settingsForm.addEventListener('submit',function(e){e.preventDefault();updateSettings();});}}function updateProfile(){const profileFirstName = document.getElementById('profileFirstName').value;const profileLastName = document.getElementById('profileLastName').value;const profilePhone = document.getElementById('profilePhone').value;const profileAddress = document.getElementById('profileAddress').value;if(!profileFirstName || !profileLastName){alert('Por favor complete los campos obligatorios(Nombre y Apellido)');return;}const user = getUser()||{};user.name = `${profileFirstName}${profileLastName}`;user.phone = profilePhone;user.address = profileAddress;localStorage.setItem('user',JSON.stringify(user));displayUserInfo(user);alert('Perfil actualizado correctamente');}function setupProfileNavigation(){}async function loadUserOrders(userId){try{const ordersList = document.getElementById('ordersList');if(!ordersList)return;ordersList.innerHTML = '<p>Cargando pedidos...</p>';const response = await fetch(`http:if(!response.ok){throw new Error('Error al cargar los pedidos');}const orders = await response.json();if(orders.length === 0){ordersList.innerHTML = '<p>No tienes pedidos aún.</p>';return;}ordersList.innerHTML = ` <div class="orders-container"> ${orders.map(order => ` <div class="order-card"> <div class="order-header"> <div> <h3>Pedido #${order.id}</h3> <p class="order-date">${new Date(order.date).toLocaleDateString('es-CL')}</p> </div> <span class="order-status ${order.status.toLowerCase()}">${order.status}</span> </div> <div class="order-items"> ${order.items.map(item => ` <div class="order-item"> <span>${item.productName}</span> <span>${item.quantity}x ${formatPrice(item.price)}</span> <span>${formatPrice(item.quantity * item.price)}</span> </div> `).join('')}</div> <div class="order-total"> <strong>Total:${formatPrice(order.total)}</strong> </div> <div class="order-details"> <p><strong>Dirección de envío:</strong> ${order.shippingAddress}</p> <p><strong>Método de pago:</strong> ${order.paymentMethod}</p> </div> </div> `).join('')}</div> `;}catch(error){console.error('Error al cargar pedidos:',error);const ordersList = document.getElementById('ordersList');if(ordersList){ordersList.innerHTML = '<p>Error al cargar los pedidos. Por favor,inténtalo nuevamente.</p>';}}}function loadUserStats(){}function changePassword(){const currentPassword = document.getElementById('currentPassword').value;const newPassword = document.getElementById('newPassword').value;const confirmNewPassword = document.getElementById('confirmNewPassword').value;if(!currentPassword || !newPassword || !confirmNewPassword){alert('Por favor complete todos los campos');return;}if(newPassword !== confirmNewPassword){alert('Las contraseñas nuevas no coinciden');return;}if(newPassword.length < 6){alert('La nueva contraseña debe tener al menos 6 caracteres');return;}alert('Contraseña actualizada correctamente');document.getElementById('changePasswordForm').reset();}function updateSettings(){const notifications = document.getElementById('notifications').checked;const newsletter = document.getElementById('newsletter').checked;alert('Configuración guardada correctamente');}function handleLogout(){localStorage.removeItem('token');localStorage.removeItem('user');window.location.href = 'index.html';}import{API_BASE_URL,isAuthenticated,isAdmin,getAuthToken,logout}from './utils.js';import{initUserMenu}from './auth.js';import * as Chart from 'https:document.addEventListener('DOMContentLoaded',function(){if(!isAuthenticated()){window.location.href = '../login.html';return;}if(!isAdmin()){window.location.href = '../index.html';return;}initUserMenu();const logoutLink = document.getElementById('logoutLink');if(logoutLink){logoutLink.addEventListener('click',function(e){e.preventDefault();logout();window.location.href = '../index.html';});}const menuLinks = document.querySelectorAll('.admin-menu a');const contentSections = document.querySelectorAll('.admin-content-section');function changeSection(sectionId){contentSections.forEach(section =>{section.classList.remove('active');});const targetSection = document.getElementById(`${sectionId}-section`);if(targetSection){targetSection.classList.add('active');const heading = targetSection.querySelector('h2');if(heading){heading.setAttribute('tabindex','-1');heading.focus();}}menuLinks.forEach(link =>{link.classList.remove('active');if(link.getAttribute('data-section')=== sectionId){link.classList.add('active');link.setAttribute('aria-current','page');}else{link.removeAttribute('aria-current');}});switch(sectionId){case 'dashboard':loadDashboardData();break;case 'products':loadAllProducts();break;case 'orders':loadOrders();break;case 'users':loadUsers();setupUserEvents();break;case 'reviews':loadReviews();break;case 'settings':initSettings();break;}}menuLinks.forEach(link =>{link.addEventListener('click',function(e){e.preventDefault();const sectionId = this.getAttribute('data-section');changeSection(sectionId);});link.setAttribute('role','tab');link.setAttribute('aria-selected','false');});loadDashboardData();setupProductEvents();setupUserEvents();setupImagePreview();initSettings();setupOrderFilter();});async function loadDashboardData(){console.log('Cargando datos del dashboard...');try{const response = await fetch(`${API_BASE_URL}/api/products/stats`,{headers:{'Authorization':`Bearer ${getAuthToken()}`}});if(!response.ok){throw new Error('Error al cargar estadísticas');}const stats = await response.json();console.log('Estadísticas cargadas:',stats);const totalProducts = document.getElementById('totalProducts');const totalOrders = document.getElementById('totalOrders');const totalUsers = document.getElementById('totalUsers');const totalRevenue = document.getElementById('totalRevenue');const avgOrderValue = document.getElementById('avgOrderValue');const conversionRate = document.getElementById('conversionRate');if(totalProducts)totalProducts.textContent = stats.totalProducts || 0;if(totalOrders)totalOrders.textContent = stats.totalOrders || 0;if(totalUsers)totalUsers.textContent = stats.totalUsers || 0;if(totalRevenue)totalRevenue.textContent = `$${(stats.totalRevenue || 0).toFixed(2)}`;const avgValue = stats.totalOrders ? stats.totalRevenue / stats.totalOrders:0;if(avgOrderValue)avgOrderValue.textContent = `$${avgValue.toFixed(2)}`;if(conversionRate)conversionRate.textContent = '5%';updateCharts(stats);}catch(error){console.error('Error al cargar datos del dashboard:',error);if(typeof showNotification === 'function'){showNotification('Error al cargar datos del dashboard','error');}else{console.error('Función showNotification no disponible');}}}function updateCharts(stats){console.log('Actualizando gráficos con estadísticas:',stats);}async function loadChartData(){try{const salesData ={labels:['Ene','Feb','Mar','Abr','May','Jun'],datasets:[{label:'Ventas',data:[12000,19000,15000,18000,22000,25000],backgroundColor:'rgba(90,143,105,0.6)',borderColor:'rgba(90,143,105,1)',borderWidth:1}]};const topProductsData ={labels:['Ramo Rosas','Arreglo Cumpleaños','Centro de Mesa','Caja Sorpresa','Bouquet Especial'],datasets:[{label:'Unidades vendidas',data:[45,38,32,28,22],backgroundColor:[ 'rgba(90,143,105,0.6)','rgba(74,122,90,0.6)','rgba(120,180,130,0.6)','rgba(60,100,75,0.6)','rgba(100,160,115,0.6)' ],borderColor:[ 'rgba(90,143,105,1)','rgba(74,122,90,1)','rgba(120,180,130,1)','rgba(60,100,75,1)','rgba(100,160,115,1)' ],borderWidth:1}]};const categoriesData ={labels:['Ramos','Arreglos','Centros de Mesa','Cajas','Especiales'],datasets:[{label:'% de ventas',data:[30,25,20,15,10],backgroundColor:[ 'rgba(90,143,105,0.6)','rgba(74,122,90,0.6)','rgba(120,180,130,0.6)','rgba(60,100,75,0.6)','rgba(100,160,115,0.6)' ],borderColor:[ 'rgba(90,143,105,1)','rgba(74,122,90,1)','rgba(120,180,130,1)','rgba(60,100,75,1)','rgba(100,160,115,1)' ],borderWidth:1}]};const salesCtx = document.getElementById('salesChart').getContext('2d');new Chart(salesCtx,{type:'line',data:salesData,options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,ticks:{callback:function(value){return '$' + value;}}}}}});const topProductsCtx = document.getElementById('topProductsChart').getContext('2d');new Chart(topProductsCtx,{type:'bar',data:topProductsData,options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}});const categoriesCtx = document.getElementById('categoriesChart').getContext('2d');new Chart(categoriesCtx,{type:'doughnut',data:categoriesData,options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'}}}});}catch(error){console.error('Error al cargar datos de gráficos:',error);}}function loadRecentActivities(){try{const activities = [{text:'Nuevo pedido #1234 realizado',time:'Hace 10 min'},{text:'Producto "Ramo de Rosas" actualizado',time:'Hace 25 min'},{text:'Nuevo usuario registrado:María López',time:'Hace 1 hora'},{text:'Pedido #1230 marcado como completado',time:'Hace 2 horas'},{text:'Nuevo producto "Arreglo Especial" agregado',time:'Hace 1 día'}];const activityList = document.getElementById('activityList');activityList.innerHTML = '';activities.forEach(activity =>{const li = document.createElement('li');li.innerHTML = ` <i class="fas fa-bell"></i> <span>${activity.text}</span> <span class="activity-time">${activity.time}</span> `;activityList.appendChild(li);});}catch(error){console.error('Error al cargar actividades recientes:',error);document.getElementById('activityList').innerHTML = '<li>Error al cargar actividades</li>';}}function setupProductEvents(){const addProductBtn = document.getElementById('addProductBtn');const addProductModalBtn = document.getElementById('addProductModalBtn');if(addProductBtn){addProductBtn.addEventListener('click',function(){showAddProductForm();});addProductBtn.setAttribute('aria-label','Agregar nuevo producto');addProductBtn.setAttribute('role','button');}if(addProductModalBtn){addProductModalBtn.addEventListener('click',function(){showAddProductForm();});addProductModalBtn.setAttribute('aria-label','Agregar nuevo producto');addProductModalBtn.setAttribute('role','button');}}function showAddProductForm(){const modal = document.createElement('div');modal.className = 'modal';modal.id = 'addProductModal';modal.setAttribute('role','dialog');modal.setAttribute('aria-labelledby','addProductModalTitle');modal.setAttribute('aria-modal','true');modal.innerHTML = ` <div class="modal-content"> <div class="modal-header"> <h3 id="addProductModalTitle">Agregar Nuevo Producto</h3> <button class="close" aria-label="Cerrar">&times;</button> </div> <div class="modal-body"> <form id="addProductForm"> <div class="form-group"> <label for="productName">Nombre:</label> <input type="text" id="productName" class="form-input" required aria-required="true"> </div> <div class="form-group"> <label for="productCategory">Categoría:</label> <input type="text" id="productCategory" class="form-input" required aria-required="true"> </div> <div class="form-group"> <label for="productPrice">Precio:</label> <input type="number" id="productPrice" class="form-input" min="0" step="100" required aria-required="true"> </div> <div class="form-group"> <label for="productImage">URL de Imagen:</label> <input type="text" id="productImage" class="form-input"> </div> <div class="form-group"> <label for="productImageFile">Subir Imagen:</label> <input type="file" id="productImageFile" class="form-input"> </div> <div class="form-group"> <label for="productDescription">Descripción:</label> <textarea id="productDescription" class="form-input" rows="3"></textarea> </div> <button type="submit" class="btn btn-primary">Agregar Producto</button> </form> </div> </div> `;document.body.appendChild(modal);const closeBtn = modal.querySelector('.close');closeBtn.addEventListener('click',function(){modal.remove();});closeBtn.setAttribute('aria-label','Cerrar modal');window.addEventListener('click',function(event){if(event.target === modal){modal.remove();}});window.addEventListener('keydown',function(event){if(event.key === 'Escape' && modal.parentNode){modal.remove();}});const form = document.getElementById('addProductForm');form.addEventListener('submit',function(e){e.preventDefault();addProduct();});modal.style.display = 'block';const firstInput = modal.querySelector('input,textarea,select');if(firstInput){firstInput.focus();}}async function addProduct(){const form = document.getElementById('addProductForm');if(!form)return;try{const formData = new FormData(form);const imageFile = document.getElementById('productImageFile').files[0];let imageUrl = formData.get('productImage');if(imageFile){imageUrl = await uploadImage(imageFile);}const productData ={name:formData.get('productName'),price:parseFloat(formData.get('productPrice')),category:formData.get('productCategory'),image:imageUrl,description:formData.get('productDescription')};if(!productData.name || !productData.price || !productData.category || productData.price <= 0){showMessage('Por favor complete todos los campos obligatorios','error');return;}if(!productData.image){productData.image = '/assets/images/default-avatar.svg';}const token = getAuthToken();const response = await fetch(`${API_BASE_URL}/api/products`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(productData)});const result = await response.json();if(!response.ok){throw new Error(result.error || 'Error al agregar producto');}const modal = document.getElementById('addProductModal');if(modal){modal.remove();}showMessage('Producto agregado correctamente','success');loadAllProducts();loadDashboardData();}catch(error){console.error('Error al agregar producto:',error);showMessage(error.message || 'Error al agregar producto','error');}}async function loadAllProducts(){try{const response = await fetch(`${API_BASE_URL}/api/products`);if(!response.ok){throw new Error('Error al cargar productos');}const data = await response.json();const products = data.products || data;const tbody = document.getElementById('allProductsTableBody');if(tbody){if(products && products.length > 0){tbody.innerHTML = products.map(product => ` <tr> <td>${product.id}</td> <td>${product.name}</td> <td>${product.description || ''}</td> <td>$${parseFloat(product.price).toLocaleString('es-CL')}</td> <td>${product.category}</td> <td><img src="${product.image || ''}" alt="${product.name}" width="50" loading="lazy"></td> <td> <button class="btn-icon edit-product" data-id="${product.id}" aria-label="Editar ${product.name}" title="Editar"> <i class="fas fa-edit" aria-hidden="true"></i> </button> <button class="btn-icon delete-product" data-id="${product.id}" aria-label="Eliminar ${product.name}" title="Eliminar"> <i class="fas fa-trash" aria-hidden="true"></i> </button> </td> </tr> `).join('');document.querySelectorAll('.edit-product').forEach(button =>{button.addEventListener('click',function(){const productId = this.getAttribute('data-id');editProduct(productId);});button.setAttribute('role','button');});document.querySelectorAll('.delete-product').forEach(button =>{button.addEventListener('click',function(){const productId = this.getAttribute('data-id');deleteProduct(productId);});button.setAttribute('role','button');});}else{tbody.innerHTML = '<tr><td colspan="7">No hay productos disponibles</td></tr>';}}}catch(error){console.error('Error al cargar productos:',error);const tbody = document.getElementById('allProductsTableBody');if(tbody){tbody.innerHTML = '<tr><td colspan="7">Error al cargar productos</td></tr>';}}}function editProduct(productId){fetch(`${API_BASE_URL}/api/products/${productId}`).then(response => response.json()).then(product =>{showEditProductForm(product);}).catch(error =>{console.error('Error al obtener producto:',error);showMessage('Error al obtener datos del producto','error');});}function showEditProductForm(product){const modal = document.createElement('div');modal.className = 'modal';modal.id = 'editProductModal';modal.setAttribute('role','dialog');modal.setAttribute('aria-labelledby','editProductModalTitle');modal.setAttribute('aria-modal','true');modal.innerHTML = ` <div class="modal-content"> <div class="modal-header"> <h3 id="editProductModalTitle">Editar Producto</h3> <button class="close" aria-label="Cerrar">&times;</button> </div> <div class="modal-body"> <form id="editProductForm"> <input type="hidden" id="productId" value="${product.id}"> <div class="form-group"> <label for="editProductName">Nombre:</label> <input type="text" id="editProductName" class="form-input" value="${product.name}" required aria-required="true"> </div> <div class="form-group"> <label for="editProductCategory">Categoría:</label> <input type="text" id="editProductCategory" class="form-input" value="${product.category}" required aria-required="true"> </div> <div class="form-group"> <label for="editProductPrice">Precio:</label> <input type="number" id="editProductPrice" class="form-input" min="0" step="100" value="${product.price}" required aria-required="true"> </div> <div class="form-group"> <label for="editProductImage">URL de Imagen:</label> <input type="text" id="editProductImage" class="form-input" value="${product.image || ''}"> </div> <div class="form-group"> <label for="editProductImageFile">Subir Imagen:</label> <input type="file" id="editProductImageFile" class="form-input"> </div> <div class="form-group"> <label for="editProductDescription">Descripción:</label> <textarea id="editProductDescription" class="form-input" rows="3">${product.description || ''}</textarea> </div> <button type="submit" class="btn btn-primary">Actualizar Producto</button> </form> </div> </div> `;document.body.appendChild(modal);const closeBtn = modal.querySelector('.close');closeBtn.addEventListener('click',function(){modal.remove();});closeBtn.setAttribute('aria-label','Cerrar modal');window.addEventListener('click',function(event){if(event.target === modal){modal.remove();}});window.addEventListener('keydown',function(event){if(event.key === 'Escape' && modal.parentNode){modal.remove();}});const form = document.getElementById('editProductForm');form.addEventListener('submit',function(e){e.preventDefault();updateProduct(product.id);});modal.style.display = 'block';const firstInput = modal.querySelector('input,textarea,select');if(firstInput){firstInput.focus();}}async function updateProduct(productId){const form = document.getElementById('editProductForm');if(!form)return;try{const formData = new FormData(form);const imageFile = document.getElementById('editProductImageFile').files[0];let imageUrl = formData.get('editProductImage');if(imageFile){imageUrl = await uploadImage(imageFile);}const productData ={name:formData.get('editProductName'),price:parseFloat(formData.get('editProductPrice')),category:formData.get('editProductCategory'),image:imageUrl,description:formData.get('editProductDescription')};if(!productData.name || !productData.price || !productData.category || productData.price <= 0){showMessage('Por favor complete todos los campos obligatorios','error');return;}if(!productData.image){productData.image = '/assets/images/default-avatar.svg';}const token = getAuthToken();const response = await fetch(`${API_BASE_URL}/api/products/${productId}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(productData)});const result = await response.json();if(!response.ok){throw new Error(result.error || 'Error al actualizar producto');}const modal = document.getElementById('editProductModal');if(modal){modal.remove();}showMessage('Producto actualizado correctamente','success');loadAllProducts();loadDashboardData();}catch(error){console.error('Error al actualizar producto:',error);showMessage(error.message || 'Error al actualizar producto','error');}}function deleteProduct(productId){if(confirm('¿Estás seguro de que deseas eliminar este producto?')){removeProduct(productId);}}async function removeProduct(productId){try{const token = getAuthToken();const response = await fetch(`${API_BASE_URL}/api/products/${productId}`,{method:'DELETE',headers:{'Authorization':`Bearer ${token}`}});if(!response.ok){throw new Error('Error al eliminar producto');}showMessage('Producto eliminado correctamente','success');loadAllProducts();loadDashboardData();}catch(error){console.error('Error al eliminar producto:',error);showMessage('Error al eliminar producto','error');}}async function loadOrders(){try{const tbody = document.getElementById('ordersTableBody');if(!tbody)return;tbody.innerHTML = '<tr><td colspan="6">Cargando pedidos...</td></tr>';const response = await fetch('http:if(!response.ok){throw new Error('Error al cargar los pedidos');}const orders = await response.json();if(orders.length > 0){tbody.innerHTML = orders.map(order => ` <tr> <td>${order.id}</td> <td>${order.customerName}</td> <td>${new Date(order.date).toLocaleDateString('es-CL')}</td> <td>$${order.total.toLocaleString('es-CL')}</td> <td><span class="status ${order.status.toLowerCase()}">${order.status}</span></td> <td> <button class="btn-icon view-order" data-id="${order.id}" aria-label="Ver pedido ${order.id}" title="Ver"> <i class="fas fa-eye" aria-hidden="true"></i> </button> <button class="btn-icon edit-order" data-id="${order.id}" aria-label="Editar pedido ${order.id}" title="Editar"> <i class="fas fa-edit" aria-hidden="true"></i> </button> </td> </tr> `).join('');document.querySelectorAll('.view-order').forEach(button =>{button.addEventListener('click',function(){const orderId = this.getAttribute('data-id');viewOrder(orderId);});});document.querySelectorAll('.edit-order').forEach(button =>{button.addEventListener('click',function(){const orderId = this.getAttribute('data-id');editOrder(orderId);});});}else{tbody.innerHTML = '<tr><td colspan="6">No hay pedidos disponibles</td></tr>';}}catch(error){console.error('Error al cargar pedidos:',error);const tbody = document.getElementById('ordersTableBody');if(tbody){tbody.innerHTML = '<tr><td colspan="6">Error al cargar pedidos</td></tr>';}}}function setupOrderFilter(){const filterSelect = document.getElementById('orderStatusFilter');if(filterSelect){filterSelect.addEventListener('change',function(){const status = this.value;filterOrders(status);});}}function filterOrders(status){showMessage(`Filtrando pedidos por estado:${status === '' ? 'Todos':status}`,'info');}function viewOrder(orderId){showMessage(`Función para ver detalles del pedido ${orderId}. En una implementación completa,aquí se mostrarían los detalles del pedido.`,'info');}function editOrder(orderId){showMessage(`Función para editar el pedido ${orderId}. En una implementación completa,aquí se podría cambiar el estado del pedido.`,'info');}function setupUserEvents(){const addUserBtn = document.getElementById('addUserBtn');if(addUserBtn){addUserBtn.addEventListener('click',()=>{showUserModal();});}const userForm = document.getElementById('userForm');if(userForm){userForm.addEventListener('submit',async(e)=>{e.preventDefault();await saveUser();});}const closeModal = document.querySelector('#userModal .close');if(closeModal){closeModal.addEventListener('click',()=>{document.getElementById('userModal').style.display = 'none';});}const userModal = document.getElementById('userModal');if(userModal){userModal.addEventListener('click',(e)=>{if(e.target === userModal){userModal.style.display = 'none';}});}}function showUserModal(user = null){const modal = document.getElementById('userModal');const title = document.getElementById('userModalTitle');if(!modal || !title){console.error('No se encontraron los elementos necesarios para mostrar el modal de usuario');return;}const userId = document.getElementById('userId');const userName = document.getElementById('userName');const userEmail = document.getElementById('userEmail');const userPhone = document.getElementById('userPhone');const userPassword = document.getElementById('userPassword');const userRole = document.getElementById('userRole');const passwordHelp = document.getElementById('passwordHelp');if(user){title.textContent = 'Editar Usuario';if(userId)userId.value = user.id;if(userName)userName.value = user.name;if(userEmail)userEmail.value = user.email;if(userPhone)userPhone.value = user.phone || '';if(userRole)userRole.value = user.role || 'user';if(userPassword)userPassword.value = '';if(passwordHelp)passwordHelp.style.display = 'block';if(userPassword)userPassword.removeAttribute('required');}else{title.textContent = 'Agregar Usuario';if(userId)userId.value = '';if(userName)userName.value = '';if(userEmail)userEmail.value = '';if(userPhone)userPhone.value = '';if(userRole)userRole.value = 'user';if(userPassword)userPassword.value = '';if(passwordHelp)passwordHelp.style.display = 'block';if(userPassword)userPassword.setAttribute('required','required');}modal.style.display = 'block';}async function saveUser(){const userId = document.getElementById('userId').value;const name = document.getElementById('userName').value;const email = document.getElementById('userEmail').value;const phone = document.getElementById('userPhone').value;const password = document.getElementById('userPassword').value;const role = document.getElementById('userRole').value;if(!name || !email || !phone ||(!userId && !password)){showMessage('Por favor complete todos los campos obligatorios','error');return;}const userData ={name,email,phone,role};if(password){userData.password = password;}try{const token = getAuthToken();let response;if(userId){response = await fetch(`${API_BASE_URL}/api/users/${userId}`,{method:'PUT',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(userData)});}else{if(!password){showMessage('La contraseña es obligatoria para nuevos usuarios','error');return;}response = await fetch(`${API_BASE_URL}/api/users`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(userData)});}const result = await response.json();if(!response.ok){throw new Error(result.error || 'Error al guardar usuario');}document.getElementById('userModal').style.display = 'none';showMessage(userId ? 'Usuario actualizado correctamente':'Usuario creado correctamente','success');loadUsers();}catch(error){console.error('Error al guardar usuario:',error);showMessage(error.message || 'Error al guardar usuario','error');}}async function loadUsers(){try{const token = getAuthToken();const response = await fetch(`${API_BASE_URL}/api/users`,{headers:{'Authorization':`Bearer ${token}`}});if(!response.ok){throw new Error('Error al cargar usuarios');}const data = await response.json();const users = data.users || [];const tbody = document.getElementById('usersTableBody');if(tbody){if(users && users.length > 0){tbody.innerHTML = users.map(user => ` <tr> <td>${user.id}</td> <td>${user.name}</td> <td>${user.email}</td> <td>${user.phone || ''}</td> <td>${user.role || 'user'}</td> <td>${user.lastLogin || 'Nunca'}</td> <td> <button class="btn-icon edit-user" data-id="${user.id}" aria-label="Editar ${user.name}" title="Editar"> <i class="fas fa-edit" aria-hidden="true"></i> </button> </td> </tr> `).join('');document.querySelectorAll('.edit-user').forEach(button =>{button.addEventListener('click',function(){const userId = this.getAttribute('data-id');editUser(userId);});});}else{tbody.innerHTML = '<tr><td colspan="7">No hay usuarios disponibles</td></tr>';}}}catch(error){console.error('Error al cargar usuarios:',error);const tbody = document.getElementById('usersTableBody');if(tbody){tbody.innerHTML = '<tr><td colspan="7">Error al cargar usuarios</td></tr>';}}}function loadAnalytics(){initCharts();loadSummaryStats();}function initCharts(){const salesCtx = document.getElementById('salesChart');if(salesCtx){new Chart(salesCtx,{type:'line',data:{labels:['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago'],datasets:[{label:'Ventas',data:[12000,19000,15000,18000,22000,19500,23000,25000],borderColor:'rgb(75,192,192)',tension:0.1,fill:false}]},options:{responsive:true,plugins:{legend:{display:false}}}});}const topProductsCtx = document.getElementById('topProductsChart');if(topProductsCtx){new Chart(topProductsCtx,{type:'bar',data:{labels:['Ramo Rosas','Arreglo Especial','Planta Interior','Caja Sorpresa','Centro de Mesa'],datasets:[{label:'Unidades vendidas',data:[45,32,28,25,22],backgroundColor:'rgba(75,192,192,0.2)',borderColor:'rgba(75,192,192,1)',borderWidth:1}]},options:{responsive:true,plugins:{legend:{display:false}}}});}const categoriesCtx = document.getElementById('categoriesChart');if(categoriesCtx){new Chart(categoriesCtx,{type:'doughnut',data:{labels:['Ramos','Arreglos','Especiales','Plantas'],datasets:[{data:[35,30,20,15],backgroundColor:[ 'rgba(255,99,132,0.2)','rgba(54,162,235,0.2)','rgba(255,205,86,0.2)','rgba(75,192,192,0.2)' ],borderColor:[ 'rgba(255,99,132,1)','rgba(54,162,235,1)','rgba(255,205,86,1)','rgba(75,192,192,1)' ]}]},options:{responsive:true,plugins:{legend:{position:'bottom'}}}});}}function loadSummaryStats(){document.getElementById('todaySales').textContent = '$12,500';document.getElementById('weekSales').textContent = '$85,300';document.getElementById('monthSales').textContent = '$325,600';}function initSettings(){loadSettings();const storeInfoForm = document.getElementById('storeInfoForm');const customizationForm = document.getElementById('customizationForm');const shippingForm = document.getElementById('shippingForm');if(storeInfoForm){storeInfoForm.addEventListener('submit',function(e){e.preventDefault();saveStoreInfo();});}if(customizationForm){customizationForm.addEventListener('submit',function(e){e.preventDefault();saveCustomization();});}if(shippingForm){shippingForm.addEventListener('submit',function(e){e.preventDefault();saveShippingSettings();});}}function loadSettings(){console.log('Cargando configuración...');const storeInfo = JSON.parse(localStorage.getItem('storeInfo'))||{};const storeName = document.getElementById('storeName');const storeEmail = document.getElementById('storeEmail');const storePhone = document.getElementById('storePhone');const storeAddress = document.getElementById('storeAddress');if(storeName)storeName.value = storeInfo.name || '';if(storeEmail)storeEmail.value = storeInfo.email || '';if(storePhone)storePhone.value = storeInfo.phone || '';if(storeAddress)storeAddress.value = storeInfo.address || '';const customization = JSON.parse(localStorage.getItem('customization'))||{};const primaryColor = document.getElementById('primaryColor');const secondaryColor = document.getElementById('secondaryColor');if(primaryColor)primaryColor.value = customization.primaryColor || '#4a7c59';if(secondaryColor)secondaryColor.value = customization.secondaryColor || '#3a6c49';const shipping = JSON.parse(localStorage.getItem('shippingSettings'))||{};const shippingCost = document.getElementById('shippingCost');if(shippingCost)shippingCost.value = shipping.cost || '';}function saveStoreInfo(){const storeInfo ={name:document.getElementById('storeName').value,email:document.getElementById('storeEmail').value,phone:document.getElementById('storePhone').value,address:document.getElementById('storeAddress').value,hours:document.getElementById('storeHours').value};localStorage.setItem('storeInfo',JSON.stringify(storeInfo));showMessage('Información de la tienda guardada correctamente','success');}function saveCustomization(){const customization ={primaryColor:document.getElementById('primaryColor').value,secondaryColor:document.getElementById('secondaryColor').value};localStorage.setItem('customization',JSON.stringify(customization));showMessage('Personalización guardada correctamente','success');applyCustomColors(customization.primaryColor,customization.secondaryColor);}function saveShippingSettings(){const shipping ={cost:document.getElementById('shippingCost').value,freeThreshold:document.getElementById('freeShippingThreshold').value,deliveryTime:document.getElementById('deliveryTime').value};localStorage.setItem('shippingSettings',JSON.stringify(shipping));showMessage('Configuración de envíos guardada correctamente','success');}function applyCustomColors(primaryColor,secondaryColor){const style = document.createElement('style');style.textContent = `:root{--primary:${primaryColor};--secondary:${secondaryColor};}`;document.head.appendChild(style);}async function editUser(userId){try{const token = getAuthToken();const response = await fetch(`${API_BASE_URL}/api/users/profile`,{headers:{'Authorization':`Bearer ${token}`}});if(!response.ok){throw new Error('Error al obtener datos del usuario');}const user = await response.json();showUserModal(user);}catch(error){console.error('Error al obtener usuario:',error);showMessage('Error al obtener datos del usuario','error');}}function setupMenuNavigation(){if(document.readyState === 'loading'){document.addEventListener('DOMContentLoaded',initMenuNavigation);}else{initMenuNavigation();}}function initMenuNavigation(){const menuLinks = document.querySelectorAll('.admin-menu a[data-section]');menuLinks.forEach(link =>{link.addEventListener('click',function(e){e.preventDefault();document.querySelectorAll('.admin-menu li').forEach(li =>{li.classList.remove('active');});this.parentElement.classList.add('active');document.querySelectorAll('.admin-content-section').forEach(section =>{section.classList.remove('active');});const targetSection = this.getAttribute('data-section');const sectionElement = document.getElementById(targetSection);if(sectionElement){sectionElement.classList.add('active');}});});}function showMessage(message,type = 'info'){let messageContainer = document.getElementById('admin-message-container');if(!messageContainer){messageContainer = document.createElement('div');messageContainer.id = 'admin-message-container';messageContainer.style.cssText = ` position:fixed;top:20px;right:20px;z-index:10000;width:300px;`;document.body.appendChild(messageContainer);}const messageElement = document.createElement('div');messageElement.style.cssText = ` padding:15px;margin-bottom:10px;border-radius:5px;color:white;font-weight:500;box-shadow:0 2px 10px rgba(0,0,0,0.1);animation:fadeIn 0.3s,fadeOut 0.3s 2.7s;`;switch(type){case 'success':messageElement.style.backgroundColor = '#28a745';break;case 'error':messageElement.style.backgroundColor = '#dc3545';break;case 'warning':messageElement.style.backgroundColor = '#ffc107';messageElement.style.color = '#212529';break;default:messageElement.style.backgroundColor = '#17a2b8';}messageElement.textContent = message;messageContainer.appendChild(messageElement);setTimeout(()=>{if(messageElement.parentNode){messageElement.parentNode.removeChild(messageElement);}},3000);}async function uploadImage(file){return new Promise((resolve,reject)=>{const reader = new FileReader();reader.onload = async function(e){try{const base64Image = e.target.result;const token = getAuthToken();const response = await fetch(`${API_BASE_URL}/api/products/upload`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({image:base64Image})});const result = await response.json();if(!response.ok){throw new Error(result.error || 'Error al subir imagen');}resolve(result.imageUrl);}catch(error){reject(error);}};reader.onerror = function(){reject(new Error('Error al leer el archivo'));};reader.readAsDataURL(file);});}function setupImagePreview(){const imageFileInput = document.getElementById('productImageFile');const imagePreview = document.getElementById('imagePreview');if(imageFileInput && imagePreview){imageFileInput.addEventListener('change',function(){const file = this.files[0];if(file){const reader = new FileReader();reader.onload = function(e){let previewImg = imagePreview.querySelector('img');if(!previewImg){previewImg = document.createElement('img');imagePreview.appendChild(previewImg);}previewImg.src = e.target.result;previewImg.style.display = 'block';};reader.readAsDataURL(file);}});}const editImageFileInput = document.getElementById('editProductImageFile');const editImagePreview = document.getElementById('editImagePreview');if(editImageFileInput && editImagePreview){editImageFileInput.addEventListener('change',function(){const file = this.files[0];if(file){const reader = new FileReader();reader.onload = function(e){let previewImg = editImagePreview.querySelector('img');if(!previewImg){previewImg = document.createElement('img');editImagePreview.appendChild(previewImg);}previewImg.src = e.target.result;previewImg.style.display = 'block';};reader.readAsDataURL(file);}});}}document.addEventListener('DOMContentLoaded',function(){const contactForm = document.getElementById('contactForm');const formMessage = document.getElementById('formMessage');if(!contactForm){console.log('Formulario de contacto no encontrado en esta página');return;}contactForm.addEventListener('submit',function(e){e.preventDefault();const name = document.getElementById('name').value;const email = document.getElementById('email').value;const phone = document.getElementById('phone').value;const message = document.getElementById('message').value;const formData ={name:name,email:email,phone:phone,message:message};showFormMessage('Enviando mensaje...','info');fetch('/api/contact',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)}).then(response => response.json()).then(data =>{if(data.status === 'success'){showFormMessage(data.message,'success');contactForm.reset();}else{showFormMessage(data.message,'error');}}).catch(error =>{console.error('Error:',error);showFormMessage('Error al enviar el mensaje. Por favor,inténtalo de nuevo.','error');});});function showFormMessage(message,type){formMessage.className = 'form-message';if(type === 'success'){formMessage.classList.add('success');}else if(type === 'error'){formMessage.classList.add('error');}else{formMessage.classList.add('info');}formMessage.textContent = message;console.log('Mensaje de formulario:',message,'Tipo:',type);}});import{showNotification,updateCartCount,API_BASE_URL,checkBackendConnectivity}from './utils.js';import{initUserMenu}from './auth.js';import{initGoogleSignIn}from './googleAuth.js';document.addEventListener('DOMContentLoaded',function(){initUserMenu();const loginForm = document.getElementById('loginForm');const registerForm = document.getElementById('registerForm');const showRegisterLink = document.getElementById('showRegister');const showLoginLink = document.getElementById('showLogin');const loginContainer = document.querySelector('.login-form-container');const registerContainer = document.querySelector('.register-form-container');const googleButton = document.getElementById('googleSignInButton');if(googleButton){const googleClientId = '888681528450-havivkoibjv0ht3vu4q46hc8k0i3f8iu.apps.googleusercontent.com';initGoogleSignIn(googleClientId,handleGoogleLoginResponse);}if(showRegisterLink){showRegisterLink.addEventListener('click',function(e){e.preventDefault();if(loginContainer)loginContainer.classList.add('hidden');if(registerContainer)registerContainer.classList.remove('hidden');});}if(showLoginLink){showLoginLink.addEventListener('click',function(e){e.preventDefault();if(registerContainer)registerContainer.classList.add('hidden');if(loginContainer)loginContainer.classList.remove('hidden');});}if(loginForm){loginForm.addEventListener('submit',function(e){e.preventDefault();handleLogin();});}if(registerForm){registerForm.addEventListener('submit',function(e){e.preventDefault();handleRegister();});}updateCartCount();});async function handleLogin(){try{console.log('Iniciando proceso de login');console.log('API_BASE_URL:',API_BASE_URL);console.log('Verificando conectividad con el backend...');const isBackendAvailable = await checkBackendConnectivity();console.log('Backend disponible:',isBackendAvailable);if(!isBackendAvailable){const errorMsg = 'No se puede conectar con el servidor. Por favor,verifica que el servidor backend esté funcionando en ' + API_BASE_URL;console.error(errorMsg);showNotification(errorMsg,'error');return;}const email = document.getElementById('loginEmail').value;const password = document.getElementById('loginPassword').value;console.log('Datos de login:',{email,password:'****'});if(!email || !password){showNotification('Por favor,completa todos los campos','error');return;}const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(email)){showNotification('Por favor,ingresa un email válido','error');return;}console.log('Realizando solicitud de inicio de sesión...');console.log('URL de la solicitud:',`${API_BASE_URL}/api/users/login`);let response;try{response = await fetch(`${API_BASE_URL}/api/users/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});}catch(fetchError){console.error('Error al realizar la solicitud:',fetchError);throw new Error(`No se pudo conectar con el servidor. Error:${fetchError.message}`);}console.log('Respuesta del servidor:',response);console.log('Estado de la respuesta:',response.status);const contentType = response.headers.get('content-type');console.log('Tipo de contenido:',contentType);if(!contentType || !contentType.includes('application/json')){const responseText = await response.text();console.error('Respuesta no JSON recibida:',responseText);if(response.status === 404){throw new Error('Endpoint no encontrado. Verifica que la ruta /api/auth/login exista en el backend.');}if(response.status === 0){throw new Error('Error de conexión. Puede ser un problema de CORS o el servidor no está respondiendo.');}const errorMsg = 'Error de conexión con el servidor. Por favor,verifica que el servidor esté funcionando correctamente.';throw new Error(errorMsg);}const data = await response.json();console.log('Datos recibidos:',data);if(!response.ok){const errorMsg = data.message || 'Error al iniciar sesión';console.error(errorMsg);throw new Error(errorMsg);}localStorage.setItem('token',data.token);localStorage.setItem('user',JSON.stringify(data.user));showNotification('Inicio de sesión exitoso','success');setTimeout(()=>{window.location.href = 'index.html';},1000);}catch(error){console.error('Error en handleLogin:',error);if(error instanceof SyntaxError){showNotification('Error al procesar la respuesta del servidor. Por favor,inténtalo nuevamente.','error');}else{showNotification(error.message,'error');}}}async function handleRegister(){try{const isBackendAvailable = await checkBackendConnectivity();if(!isBackendAvailable){showNotification('No se puede conectar con el servidor. Por favor,verifica que el servidor backend esté funcionando en ' + API_BASE_URL,'error');return;}const firstName = document.getElementById('firstName').value;const lastName = document.getElementById('lastName').value;const email = document.getElementById('registerEmail').value;const phone = document.getElementById('phone').value;const password = document.getElementById('registerPassword').value;const confirmPassword = document.getElementById('confirmPassword').value;if(!firstName || !lastName || !email || !phone || !password || !confirmPassword){showNotification('Por favor,completa todos los campos','error');return;}const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(email)){showNotification('Por favor,ingresa un email válido','error');return;}const phoneRegex = /^(\+56)?[\s\-]?[9\d][\s\-]?\d{4}[\s\-]?\d{4}$/;if(!phoneRegex.test(phone.replace(/\s+/g,' ').trim())){showNotification('Por favor,ingresa un teléfono válido(ej:+56912345678)','error');return;}if(password.length < 6){showNotification('La contraseña debe tener al menos 6 caracteres','error');return;}if(password !== confirmPassword){showNotification('Las contraseñas no coinciden','error');return;}const response = await fetch(`${API_BASE_URL}/api/auth/register`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({firstName,lastName,email,phone,password})});const contentType = response.headers.get('content-type');if(!contentType || !contentType.includes('application/json')){throw new Error('Error de conexión con el servidor. Por favor,verifica que el servidor esté funcionando.');}const data = await response.json();if(!response.ok){throw new Error(data.message || 'Error al registrar usuario');}showNotification('Usuario registrado exitosamente. Ahora puedes iniciar sesión.','success');setTimeout(()=>{const loginContainer = document.querySelector('.login-form-container');const registerContainer = document.querySelector('.register-form-container');if(registerContainer)registerContainer.classList.add('hidden');if(loginContainer)loginContainer.classList.remove('hidden');},2000);}catch(error){if(error instanceof SyntaxError){showNotification('Error al procesar la respuesta del servidor. Por favor,inténtalo nuevamente.','error');}else{showNotification(error.message,'error');}}}function handleGoogleLoginResponse(error,result){if(error){console.error('Error en inicio de sesión con Google:',error);showNotification('Error al iniciar sesión con Google:' + error.message,'error');return;}if(result.success){showNotification('Inicio de sesión exitoso. Bienvenido ' + result.user.name,'success');setTimeout(()=>{if(result.user.role === 'admin'){window.location.href = 'pages/admin.html';}else{window.location.href = 'index.html';}},1500);}else{showNotification(result.message || 'Error al iniciar sesión con Google','error');}}updateCartCount();import{updateCartCount,showNotification,API_BASE_URL}from './utils.js';import productManager from './productManager.js';import CartUtils from './cartUtils.js';import{initUserMenu}from './auth.js';document.addEventListener('DOMContentLoaded',async function(){console.log('DOM cargado en home.js');CartUtils.init();try{initUserMenu();console.log('Menú de usuario inicializado en home.js');}catch(error){console.error('Error al inicializar el menú de usuario en home.js:',error);}productManager.initCartEventListeners();updateCartCount();await loadFeaturedProducts();});async function loadFeaturedProducts(){try{const response = await fetch(`${API_BASE_URL}/api/products?limit=4`);if(!response.ok){throw new Error('Failed to load products');}const data = await response.json();const products = data.products || data;const featuredProductsContainer = document.getElementById('featuredProducts');if(products && products.length > 0){featuredProductsContainer.innerHTML = products.map(product => `<div class="product-card"> <div class="product-image"> <img src="${product.image}" alt="${product.name}" onerror="this.src='https:<button class="add-to-cart" data-product-id="${product.id}"> <i class="fas fa-shopping-cart"></i> Agregar al carrito </button> </div> <div class="product-info"> <h3>${product.name}</h3> <p class="product-description">${product.description}</p> <div class="product-price">$${product.price.toLocaleString()}</div> </div> </div>`).join('');}else{featuredProductsContainer.innerHTML = '<p class="no-products">No hay productos destacados disponibles.</p>';}}catch(error){console.error('Error loading featured products:',error);showNotification('Error al cargar productos destacados','error');}}let cart = [];let cartCount = 0;function loadCartFromLocalStorage(){try{const savedCart = localStorage.getItem('arreglosVictoriaCart');if(savedCart){cart = JSON.parse(savedCart);cartCount = cart.reduce((total,item)=> total + item.quantity,0);console.log('Carrito cargado desde localStorage:',cart);}}catch(error){console.error('Error al cargar el carrito desde localStorage:',error);cart = [];cartCount = 0;}}function saveCartToLocalStorage(){try{localStorage.setItem('arreglosVictoriaCart',JSON.stringify(cart));console.log('Carrito guardado en localStorage:',cart);}catch(error){console.error('Error al guardar el carrito en localStorage:',error);}}function updateCartCount(){const cartCountElement = document.querySelector('.cart-count');const cartCountElementById = document.getElementById('cartCount');if(cartCountElement){cartCountElement.textContent = cartCount;console.log('Contador del carrito actualizado:',cartCount);}else if(cartCountElementById){cartCountElementById.textContent = cartCount;console.log('Contador del carrito actualizado:',cartCount);}else{const fallbackElements = document.querySelectorAll('.cart-count,#cartCount');fallbackElements.forEach(element =>{element.textContent = cartCount;});if(fallbackElements.length > 0){console.log('Contador del carrito actualizado(fallback):',cartCount);}}}function calculateCartTotal(){const total = cart.reduce((total,item)=> total +(item.price * item.quantity),0);console.log('Total del carrito calculado:',total);return total;}function formatPrice(price){return new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP'}).format(price);}function renderCartItems(){const cartItemsContainer = document.querySelector('.cart-items');const cartTotalElement = document.querySelector('.total-amount');const checkoutButton = document.querySelector('.checkout-button');if(!cartItemsContainer)return;if(cart.length === 0){cartItemsContainer.innerHTML = ` <div class="empty-cart"> <i class="fas fa-shopping-cart fa-3x"></i> <h3>Tu carrito está vacío</h3> <p>Agrega productos para comenzar</p> <button class="btn btn-primary continue-shopping">Continuar comprando</button> </div> `;if(cartTotalElement)cartTotalElement.textContent = formatPrice(0);if(checkoutButton)checkoutButton.disabled = true;console.log('Carrito vacío renderizado');const continueShoppingBtn = document.querySelector('.continue-shopping');if(continueShoppingBtn){continueShoppingBtn.addEventListener('click',function(){const cartModal = document.getElementById('cartModal');if(cartModal){cartModal.style.display = 'none';}});}return;}let cartItemsHTML = '';cart.forEach(item =>{cartItemsHTML += ` <div class="cart-item" data-id="${item.id}"> <div class="item-image"> <img src="${item.image || './assets/images/placeholder.svg'}" alt="${item.name}"> </div> <div class="item-info"> <h4>${item.name}</h4> <div class="item-price">${formatPrice(item.price)}</div> <div class="item-quantity"> <button class="quantity-btn decrease-quantity" data-id="${item.id}">-</button> <span>${item.quantity}</span> <button class="quantity-btn increase-quantity" data-id="${item.id}">+</button> </div> </div> <div class="item-total"> ${formatPrice(item.price * item.quantity)}</div> <button class="remove-item" data-id="${item.id}"> <i class="fas fa-trash"></i> </button> </div> `;});cartItemsContainer.innerHTML = cartItemsHTML;if(cartTotalElement)cartTotalElement.textContent = formatPrice(calculateCartTotal());if(checkoutButton)checkoutButton.disabled = false;document.querySelectorAll('.decrease-quantity').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.getAttribute('data-id'));console.log('Disminuyendo cantidad para item ID:',id);updateQuantity(id,-1);});});document.querySelectorAll('.increase-quantity').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.getAttribute('data-id'));console.log('Aumentando cantidad para item ID:',id);updateQuantity(id,1);});});document.querySelectorAll('.remove-item').forEach(button =>{button.addEventListener('click',function(){const id = parseInt(this.getAttribute('data-id'));console.log('Eliminando item ID:',id);removeFromCart(id);});});console.log('Items del carrito renderizados:',cart);}function updateQuantity(id,change){const item = cart.find(item => item.id === id);if(item){item.quantity += change;if(item.quantity <= 0){removeFromCart(id);}else{cartCount += change;updateCartCount();saveCartToLocalStorage();renderCartItems();console.log('Cantidad actualizada para item ID:',id,'Nueva cantidad:',item.quantity);}}}function removeFromCart(id){const itemIndex = cart.findIndex(item => item.id === id);if(itemIndex !== -1){cartCount -= cart[itemIndex].quantity;cart.splice(itemIndex,1);updateCartCount();saveCartToLocalStorage();renderCartItems();console.log('Item eliminado del carrito. ID:',id);showNotification('Producto eliminado del carrito','success');}}function addToCart(id,name,price,image = null){const existingItem = cart.find(item => item.id === id);if(existingItem){existingItem.quantity += 1;console.log('Producto ya existente en carrito. Incrementando cantidad. ID:',id);showNotification(`${name}actualizado en el carrito`,'success');}else{cart.push({id:id,name:name,price:parseFloat(price),quantity:1,image:image});console.log('Nuevo producto agregado al carrito. ID:',id,'Nombre:',name);showNotification(`${name}agregado al carrito`,'success');}cartCount++;updateCartCount();saveCartToLocalStorage();showProductAddedNotification(name);}function showProductAddedNotification(productName){const notification = document.createElement('div');notification.className = 'product-notification';notification.innerHTML = ` <i class="fas fa-check-circle"></i> <span>${productName}agregado al carrito</span> <button class="view-cart-btn">Ver carrito</button> `;notification.style.position = 'fixed';notification.style.bottom = '20px';notification.style.right = '20px';notification.style.backgroundColor = 'var(--success)';notification.style.color = 'white';notification.style.padding = '15px 20px';notification.style.borderRadius = '5px';notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';notification.style.zIndex = '1000';notification.style.display = 'flex';notification.style.alignItems = 'center';notification.style.gap = '10px';notification.style.opacity = '0';notification.style.transition = 'opacity 0.3s ease';notification.style.maxWidth = '300px';document.body.appendChild(notification);setTimeout(()=>{notification.style.opacity = '1';},10);const viewCartBtn = notification.querySelector('.view-cart-btn');if(viewCartBtn){viewCartBtn.addEventListener('click',function(){const cartModal = document.getElementById('cartModal');if(cartModal){cartModal.style.display = 'block';renderCartItems();}notification.style.opacity = '0';setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},300);});}setTimeout(()=>{notification.style.opacity = '0';setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},300);},5000);}function showNotification(message,type = 'info'){const notification = document.createElement('div');notification.className = `notification notification-${type}`;notification.innerHTML = ` <i class="fas fa-${type === 'success' ? 'check-circle':type === 'error' ? 'exclamation-circle':'info-circle'}"></i> <span>${message}</span> `;notification.style.position = 'fixed';notification.style.top = '20px';notification.style.right = '20px';notification.style.backgroundColor = type === 'success' ? 'var(--success)':type === 'error' ? 'var(--danger)':'var(--primary)';notification.style.color = 'white';notification.style.padding = '15px 20px';notification.style.borderRadius = '5px';notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';notification.style.zIndex = '1000';notification.style.display = 'flex';notification.style.alignItems = 'center';notification.style.gap = '10px';notification.style.opacity = '0';notification.style.transition = 'opacity 0.3s ease';notification.style.maxWidth = '300px';document.body.appendChild(notification);setTimeout(()=>{notification.style.opacity = '1';},10);setTimeout(()=>{notification.style.opacity = '0';setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},300);},3000);}function showFormMessage(type,message){const messageElement = document.getElementById('formMessage');if(messageElement){messageElement.textContent = message;messageElement.className = `form-message ${type}`;console.log('Mensaje mostrado en formulario:',type,message);setTimeout(()=>{messageElement.className = 'form-message';},5000);}}async function handleContactFormSubmit(event){console.log('Función handleContactFormSubmit llamada');event.preventDefault();console.log('Evento preventDefault ejecutado');const name = document.getElementById('name').value;const email = document.getElementById('email').value;const phone = document.getElementById('phone').value;const message = document.getElementById('message').value;console.log('Datos del formulario:',{name,email,phone,message});if(!name || !email || !message){showFormMessage('error','Por favor,completa todos los campos requeridos.');return;}const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!emailRegex.test(email)){showFormMessage('error','Por favor,ingresa un correo electrónico válido.');return;}const submitButton = document.querySelector('#contactForm .btn');const originalText = submitButton.textContent;submitButton.textContent = 'Enviando...';submitButton.disabled = true;try{console.log('Enviando datos al backend...');const url = '/api/contact';console.log('URL de la solicitud:',url);const formData ={name,email,phone,message};console.log('Datos a enviar:',formData);const fetchOptions ={method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(formData)};console.log('Opciones de fetch:',fetchOptions);const response = await fetch(url,fetchOptions);console.log('Respuesta recibida del backend:',response);console.log('Estado de la respuesta:',response.status);console.log('Texto de estado:',response.statusText);if(!response.ok){let errorMessage = `Error HTTP ${response.status}:${response.statusText}`;try{const errorResult = await response.json();console.log('Resultado de error del servidor:',errorResult);if(errorResult && errorResult.message){errorMessage = errorResult.message;}}catch(parseError){console.error('Error al parsear la respuesta de error:',parseError);try{const errorText = await response.text();console.log('Texto de error del servidor:',errorText);if(errorText){errorMessage = errorText;}}catch(textError){console.error('Error al obtener el texto de error:',textError);}}console.error('Error del servidor:',response.status,response.statusText);showFormMessage('error',errorMessage);return;}const result = await response.json();console.log('Datos de la respuesta:',result);if(result.status === 'success'){showFormMessage('success',result.message);document.getElementById('contactForm').reset();if(message.includes('estoy interesado en los siguientes productos')){cart = [];cartCount = 0;updateCartCount();saveCartToLocalStorage();renderCartItems();}}else{showFormMessage('error',result.message || 'Error al procesar el formulario. Por favor,inténtalo de nuevo más tarde.');}}catch(error){console.error('Error al enviar el formulario:',error);console.error('Nombre del error:',error.name);console.error('Mensaje del error:',error.message);console.error('Stack trace:',error.stack);if(error.name === 'TypeError' && error.message.includes('fetch')){showFormMessage('error','Error de conexión. Por favor,verifica tu conexión a internet e inténtalo nuevamente.');}else{showFormMessage('error','Error al enviar el mensaje. Por favor,inténtalo de nuevo más tarde.');}}finally{submitButton.textContent = originalText;submitButton.disabled = false;}}function initializeEventListeners(){console.log('Inicializando event listeners');const addToCartButtons = document.querySelectorAll('.add-to-cart');console.log('Botones "Agregar al carrito" encontrados:',addToCartButtons.length);addToCartButtons.forEach(button =>{button.addEventListener('click',function(){const id = this.getAttribute('data-id');const name = this.getAttribute('data-name');const price = this.getAttribute('data-price');const image = this.closest('.product-card').querySelector('.product-image img')?.src || null;console.log('Botón "Agregar al carrito" presionado. ID:',id,'Nombre:',name,'Precio:',price);addToCart(parseInt(id),name,price,image);});});const contactForm = document.getElementById('contactForm');console.log('Formulario de contacto encontrado:',contactForm);if(contactForm){contactForm.addEventListener('submit',handleContactFormSubmit);console.log('Event listener adjuntado al formulario de contacto');}else{console.log('No se encontró el formulario de contacto');}const cartIcon = document.querySelector('.cart-icon');const cartModal = document.getElementById('cartModal');const cartClose = document.querySelector('.cart-close');if(cartIcon){cartIcon.addEventListener('click',function(){console.log('Icono del carrito presionado');if(cartModal){cartModal.style.display = 'block';renderCartItems();}});}if(cartClose){cartClose.addEventListener('click',function(){console.log('Botón cerrar carrito presionado');if(cartModal){cartModal.style.display = 'none';}});}if(cartModal){cartModal.addEventListener('click',function(event){if(event.target === cartModal){console.log('Clic fuera del modal del carrito');cartModal.style.display = 'none';}});}const checkoutButton = document.querySelector('.checkout-button');if(checkoutButton){checkoutButton.addEventListener('click',function(){console.log('Botón "Proceder al Pedido" presionado');if(cartModal){cartModal.style.display = 'none';}const contactoSection = document.getElementById('contacto');if(contactoSection){contactoSection.scrollIntoView({behavior:'smooth'});const cartSummary = cart.map(item => `${item.name}(x${item.quantity})- ${formatPrice(item.price * item.quantity)}`).join('\n');const messageArea = document.getElementById('message');if(messageArea){messageArea.value = `Hola,estoy interesado en los siguientes productos:\n${cartSummary}\n\nTotal:${formatPrice(calculateCartTotal())}\n\nMe gustaría obtener más información sobre estos productos.`;console.log('Mensaje pre-rellenado con productos del carrito');}}});}}function checkAndAttachFormListener(){const contactForm = document.getElementById('contactForm');if(contactForm && !contactForm.dataset.listenerAttached){contactForm.addEventListener('submit',handleContactFormSubmit);contactForm.dataset.listenerAttached = 'true';console.log('Event listener adjuntado al formulario de contacto');}}async function loadProducts(){const productGrid = document.querySelector('.product-grid');if(!productGrid)return;console.log('Cargando productos...');productGrid.innerHTML = '<div class="loading-message">Cargando productos...</div>';try{const response = await fetch('/api/products');if(!response.ok){throw new Error(`Error al cargar productos:${response.status}${response.statusText}`);}const data = await response.json();const products = data.products || data;console.log('Productos cargados exitosamente:',products.length);if(products.length > 0){const productsHTML = products.map(product => ProductCard(product)).join('');productGrid.innerHTML = productsHTML;attachCartEventListeners();}else{productGrid.innerHTML = '<div class="no-products-message">No hay productos disponibles en este momento.</div>';}}catch(error){console.error('Error al cargar productos:',error);showNotification(`Error al cargar productos:${error.message}`,'error');if(productGrid){productGrid.innerHTML = '<div class="error-message">Error al cargar productos. Por favor,inténtelo más tarde.</div>';}}}function attachCartEventListeners(){document.querySelectorAll('.add-to-cart').forEach(button =>{button.addEventListener('click',function(){const product ={id:this.dataset.id,name:this.dataset.name,price:parseFloat(this.dataset.price),image:this.dataset.image,quantity:1};window.productManager.addToCart(product);});});console.log('Event listeners de carrito adjuntados');}function addToCart(product){const existingProductIndex = cart.findIndex(item => item.id == product.id);if(existingProductIndex !== -1){cart[existingProductIndex].quantity += 1;console.log('Cantidad actualizada para producto existente:',product.name);}else{cart.push(product);console.log('Producto agregado al carrito:',product.name);}cartCount = cart.reduce((total,item)=> total + item.quantity,0);updateCartCount();saveCartToLocalStorage();showNotification(`${product.name}agregado al carrito`,'success');}function showNotification(message,type){const notification = document.createElement('div');notification.className = `notification ${type}`;notification.textContent = message;notification.style.cssText = ` position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:5px;color:white;font-weight:500;z-index:10000;box-shadow:0 4px 12px rgba(0,0,0,0.15);transform:translateX(100%);transition:transform 0.3s ease-in-out;`;if(type === 'success'){notification.style.backgroundColor = '#48bb78';}else if(type === 'error'){notification.style.backgroundColor = '#e53e3e';}else{notification.style.backgroundColor = '#3182ce';}document.body.appendChild(notification);setTimeout(()=>{notification.style.transform = 'translateX(0)';},10);setTimeout(()=>{notification.style.transform = 'translateX(100%)';setTimeout(()=>{if(notification.parentNode){notification.parentNode.removeChild(notification);}},300);},3000);console.log('Notificación mostrada:',message,type);}function handleNavigation(){document.querySelectorAll('a[href^="#"]').forEach(anchor =>{anchor.addEventListener('click',function(e){e.preventDefault();const targetId = this.getAttribute('href');const targetSection = document.querySelector(targetId);if(targetSection){targetSection.scrollIntoView({behavior:'smooth'});console.log('Navegando a sección:',targetId);if(targetId === '#featured-products'){loadProducts();}}});});console.log('Event listeners de navegación configurados');}const API_BASE_URL = '/api';async function loadProducts(){const productGrid = document.querySelector('.product-grid');const featuredProductsContainer = document.getElementById('featuredProductsContainer');if(!productGrid && !featuredProductsContainer)return;console.log('Cargando productos...');if(productGrid){productGrid.innerHTML = '<div class="loading-message">Cargando productos...</div>';}if(featuredProductsContainer){featuredProductsContainer.innerHTML = '<div class="loading-message">Cargando productos...</div>';}try{const response = await fetch(`${API_BASE_URL}/products?limit=4`);if(!response.ok){throw new Error(`Error al cargar productos:${response.status}${response.statusText}`);}const data = await response.json();const products = data.products || data;console.log('Productos cargados exitosamente:',products.length);if(products.length > 0){const productsHTML = products.map(product => ` <div class="product-card"> <div class="product-image"> <img src="${product.image || './assets/images/placeholder.svg'}" alt="${product.name || 'Producto sin nombre'}" loading="lazy" itemprop="image" width="300" height="200" decoding="async" fetchpriority="auto" onerror="this.src='./assets/images/placeholder.svg'"> </div> <div class="product-info"> <h3>${product.name}</h3> <p class="product-description">${product.description || 'Descripción no disponible'}</p> <p class="product-price">${formatPrice(product.price)}</p> <button class="btn btn-primary add-to-cart" data-id="${product.id}" data-name="${product.name}" data-price="${product.price}" data-image="${product.image || ''}"> <i class="fas fa-shopping-cart"></i> Agregar al carrito </button> </div> </div> `).join('');if(productGrid){productGrid.innerHTML = productsHTML;attachCartEventListeners();}if(featuredProductsContainer){featuredProductsContainer.innerHTML = productsHTML;const addToCartButtons = featuredProductsContainer.querySelectorAll('.add-to-cart');addToCartButtons.forEach(button =>{button.addEventListener('click',function(){const id = this.getAttribute('data-id');const name = this.getAttribute('data-name');const price = parseFloat(this.getAttribute('data-price'));const image = this.getAttribute('data-image');addToCart(parseInt(id),name,price,image);});});}}else{if(productGrid){productGrid.innerHTML = '<div class="no-products-message">No hay productos disponibles en este momento.</div>';}if(featuredProductsContainer){featuredProductsContainer.innerHTML = '<div class="no-products-message">No hay productos disponibles en este momento.</div>';}}}catch(error){console.error('Error al cargar productos:',error);showNotification(`Error al cargar productos:${error.message}`,'error');const errorMessage = '<div class="error-message">Error al cargar productos. Por favor,inténtelo más tarde.</div>';if(productGrid){productGrid.innerHTML = errorMessage;}if(featuredProductsContainer){featuredProductsContainer.innerHTML = errorMessage;}}}document.addEventListener('DOMContentLoaded',function(){console.log('DOM completamente cargado');loadCartFromLocalStorage();updateCartCount();handleNavigation();if(typeof initUserMenu === 'function'){initUserMenu();}if(window.location.pathname === '/' || window.location.pathname === '/index.html' || window.location.pathname.endsWith('/index.html')){loadProducts();}setTimeout(function(){console.log('Inicializando aplicación después de la demora');initializeEventListeners();},100);const formCheckInterval = setInterval(()=>{checkAndAttachFormListener();},500);setTimeout(()=>{clearInterval(formCheckInterval);},5000);});function initializeEventListeners(){checkAndAttachFormListener();console.log('Inicialización completada');}window.addEventListener('load',function(){console.log('Ventana completamente cargada');setTimeout(()=>{checkAndAttachFormListener();},100);});function handleImageError(imgElement){imgElement.src = './assets/images/placeholder.svg';}